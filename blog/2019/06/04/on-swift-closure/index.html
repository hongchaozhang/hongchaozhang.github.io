
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Swift Closure - Reading Space</title>
	<meta name="author" content="Zhang Hongchao">

	
	<meta name="description" content="Swift Closure Function与Closure的关系：
用Closure初始化一个变量
Closure的语法糖：
Closure与内存管理、内存泄漏 Capture List的定义
Weak and Unowned References Closure捕获变量 Functional &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Reading Space" type="application/atom+xml">
	
	<link rel="canonical" href="http://hongchaozhang.github.io/blog/2019/06/04/on-swift-closure/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-62806905-2']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="/blog/archives">Archives</a></li>
    <li><a href="#">About</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		
		
			<a class="github" href="https://github.com/hongchaozhang" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>



<section class="categories">
          <ul id="category_cloud" class="nav nav-list"><a href='/blog/categories/algorithm' style='font-size: 102.55319148936171%'>algorithm(2)</a> <a href='/blog/categories/android' style='font-size: 107.65957446808511%'>android(6)</a> <a href='/blog/categories/android-studio' style='font-size: 101.27659574468085%'>android studio(1)</a> <a href='/blog/categories/augmented-reality' style='font-size: 105.1063829787234%'>augmented reality(4)</a> <a href='/blog/categories/cs' style='font-size: 101.27659574468085%'>cs(1)</a> <a href='/blog/categories/css' style='font-size: 103.82978723404256%'>css(3)</a> <a href='/blog/categories/design-pattern' style='font-size: 103.82978723404256%'>design pattern(3)</a> <a href='/blog/categories/html' style='font-size: 105.1063829787234%'>html(4)</a> <a href='/blog/categories/http' style='font-size: 103.82978723404256%'>http(3)</a> <a href='/blog/categories/ios' style='font-size: 157.4468085106383%'>ios(45)</a> <a href='/blog/categories/java' style='font-size: 102.55319148936171%'>java(2)</a> <a href='/blog/categories/javascript' style='font-size: 108.93617021276596%'>javascript(7)</a> <a href='/blog/categories/machine-learning' style='font-size: 112.76595744680851%'>machine learning(10)</a> <a href='/blog/categories/map-tech' style='font-size: 103.82978723404256%'>map tech(3)</a> <a href='/blog/categories/mobile' style='font-size: 101.27659574468085%'>mobile(1)</a> <a href='/blog/categories/mongodb' style='font-size: 101.27659574468085%'>mongodb(1)</a> <a href='/blog/categories/music' style='font-size: 108.93617021276596%'>music(7)</a> <a href='/blog/categories/nlp' style='font-size: 102.55319148936171%'>nlp(2)</a> <a href='/blog/categories/nlu' style='font-size: 102.55319148936171%'>nlu(2)</a> <a href='/blog/categories/nodejs' style='font-size: 108.93617021276596%'>nodejs(7)</a> <a href='/blog/categories/objective-c' style='font-size: 128.08510638297872%'>objective-c(22)</a> <a href='/blog/categories/philosophy' style='font-size: 102.55319148936171%'>philosophy(2)</a> <a href='/blog/categories/productivity' style='font-size: 130.63829787234042%'>productivity(24)</a> <a href='/blog/categories/python' style='font-size: 107.65957446808511%'>python(6)</a> <a href='/blog/categories/react' style='font-size: 101.27659574468085%'>react(1)</a> <a href='/blog/categories/reading' style='font-size: 160.0%'>reading(47)</a> <a href='/blog/categories/server' style='font-size: 101.27659574468085%'>server(1)</a> <a href='/blog/categories/swift' style='font-size: 108.93617021276596%'>swift(7)</a> <a href='/blog/categories/web' style='font-size: 116.59574468085106%'>web(13)</a> <a href='/blog/categories/wwdc' style='font-size: 102.55319148936171%'>wwdc(2)</a> <a href='/blog/categories/xcode' style='font-size: 110.2127659574468%'>xcode(8)</a> </ul>
      </section>


</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Swift Closure</h1>
	<div class="entry-content" itemprop="articleBody"><!-- more -->


<ul>
<li><a href="#function%E4%B8%8Eclosure%E7%9A%84%E5%85%B3%E7%B3%BB">Function与Closure的关系：</a></li>
<li><a href="#%E7%94%A8closure%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E4%B8%AA%E5%8F%98%E9%87%8F">用Closure初始化一个变量</a></li>
<li><a href="#closure%E7%9A%84%E8%AF%AD%E6%B3%95%E7%B3%96">Closure的语法糖：</a></li>
<li><a href="#closure%E4%B8%8E%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F">Closure与内存管理、内存泄漏</a>

<ul>
<li><a href="#capture-list%E7%9A%84%E5%AE%9A%E4%B9%89">Capture List的定义</a></li>
<li><a href="#weak-and-unowned-references">Weak and Unowned References</a></li>
</ul>
</li>
<li><a href="#closure%E6%8D%95%E8%8E%B7%E5%8F%98%E9%87%8F">Closure捕获变量</a></li>
</ul>


<p><a href="https://medium.com/@abhimuralidharan/functional-swift-all-about-closures-310bc8af31dd">Functional swift: All about Closures</a></p>

<p>这篇全面详细易懂地介绍了Swift的Closure，包括</p>

<ul>
<li>Closure的语法，包括一些简化写法，如Trailing Closures</li>
<li>Closure与Function的区别</li>
<li>Closure与内存管理、内存泄漏，如capture list的使用，weak与unowned的区别</li>
<li>Functions和closures都是引用类型，不是值类型</li>
</ul>


<p>也可以看<a href="https://docs.swift.org/swift-book/LanguageGuide/Closures.html">官方文档Closures</a>，但是官方文档没有上面的文章详细。</p>

<p>下面有选择地记录一下。</p>

<p><a id="markdown-function与closure的关系" name="function与closure的关系"></a></p>

<h2>Function与Closure的关系：</h2>

<p>参考<a href="https://docs.swift.org/swift-book/LanguageGuide/Closures.html">官方文档Closures</a>里面的三句话理解一下：</p>

<blockquote><ul>
<li>Global functions are closures that have a name and do not capture any values.</li>
<li>Nested functions are closures that have a name and can capture values from their enclosing function.</li>
<li>Closure expressions are unnamed closures written in a lightweight syntax that can capture values from their surrounding context.</li>
</ul>
</blockquote>

<p>还有一点很重要：<strong>Closures and functions are first class types in swift</strong>。</p>

<blockquote><p>Functions and closures are first-class citizens in Swift because you can treat then like a normal value. For example, you can：</p>

<ul>
<li>assign a function/closure to a local variable .</li>
<li>pass a function/closure as an argument .</li>
<li>return a function/closure .</li>
</ul>
</blockquote>

<p><a id="markdown-用closure初始化一个变量" name="用closure初始化一个变量"></a></p>

<h2>用Closure初始化一个变量</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let setupViewUsingClosure: UIView = {
</span><span class='line'>    let view = UIView()
</span><span class='line'>    view.backgroundColor = .green
</span><span class='line'>    return view
</span><span class='line'>}() //IMPORTANT!!! I have added () at the end.</span></code></pre></td></tr></table></div></figure>


<p><a id="markdown-closure的语法糖" name="closure的语法糖"></a></p>

<h2>Closure的语法糖：</h2>

<p><a href="https://docs.swift.org/swift-book/LanguageGuide/Closures.html">官方文档Closures</a>有个总的说明：</p>

<blockquote><p>Swift’s closure expressions have a clean, clear style, with optimizations that encourage brief, clutter-free syntax in common scenarios. These optimizations include:</p>

<ul>
<li>Inferring parameter and return value types from context</li>
<li>Implicit returns from single-expression closures</li>
<li>Shorthand argument names</li>
<li>Trailing closure syntax</li>
</ul>
</blockquote>

<p>当你第一次看到这个写法的时候肯定很疑惑：参数、类型、函数调用时的括号都跑哪去了？</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let names = ["Chris", "Alex", "Ewa", "Barry", "Daniella"]
</span><span class='line'>rreversedNames = names.sorted { $0 &gt; $1 }</span></code></pre></td></tr></table></div></figure>


<p>理解了上面几点，就可以明白为什么可以这么写，下面让我们一步步看清楚。</p>

<p>Closure的定义如下：</p>

<blockquote><p>Closure expressions are unnamed closures written in a lightweight syntax that can capture values from their surrounding context.</p>

<pre><code>{ (params) -&gt; returnType in
    statements
}
</code></pre></blockquote>

<p>举个具体的例子：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let names = ["Chris", "Alex", "Ewa", "Barry", "Daniella"]
</span><span class='line'>reversedNames = names.sorted(by: { (s1: String, s2: String) -&gt; Bool in
</span><span class='line'>    return s1 &gt; s2
</span><span class='line'>})</span></code></pre></td></tr></table></div></figure>


<p>因为：</p>

<blockquote><ul>
<li><strong>Inferring parameter and return value types from context</strong></li>
</ul>


<p>Because the sorting closure is passed as an argument to a method, Swift can infer the types of its parameters and the type of the value it returns.</p></blockquote>

<p>所以，上面的代码可以写为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let names = ["Chris", "Alex", "Ewa", "Barry", "Daniella"]
</span><span class='line'>reversedNames = names.sorted(by: { s1, s2 in return s1 &gt; s2 } )</span></code></pre></td></tr></table></div></figure>


<p>再因为：</p>

<blockquote><ul>
<li><strong>Implicit returns from single-expression closures</strong></li>
</ul>


<p>Single-expression closures can implicitly return the result of their single expression by omitting the return keyword from their declaration.</p></blockquote>

<p>所以，代码继续改为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let names = ["Chris", "Alex", "Ewa", "Barry", "Daniella"]
</span><span class='line'>reversedNames = names.sorted(by: { s1, s2 in s1 &gt; s2 } )</span></code></pre></td></tr></table></div></figure>


<p>再因为：</p>

<blockquote><ul>
<li><strong>Shorthand argument names</strong></li>
</ul>


<p>Swift automatically provides shorthand argument names to inline closures, which can be used to refer to the values of the closure’s arguments by the names $0, $1, $2, and so on.</p></blockquote>

<p>代码继续改为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let names = ["Chris", "Alex", "Ewa", "Barry", "Daniella"]
</span><span class='line'>rreversedNames = names.sorted(by: { $0 &gt; $1 } )</span></code></pre></td></tr></table></div></figure>


<p>再因为：</p>

<blockquote><ul>
<li><strong>Trailing closure syntax</strong></li>
</ul>


<p>If you need to pass a closure expression to a function as the function’s final argument and the closure expression is long, it can be useful to write it as a trailing closure instead. A trailing closure is written after the function call’s parentheses, even though it is still an argument to the function. When you use the trailing closure syntax, you don’t write the argument label for the closure as part of the function call.</p></blockquote>

<p>代码就可以写成：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let names = ["Chris", "Alex", "Ewa", "Barry", "Daniella"]
</span><span class='line'>rreversedNames = names.sorted { $0 &gt; $1 }</span></code></pre></td></tr></table></div></figure>


<p><a id="markdown-closure与内存管理内存泄漏" name="closure与内存管理内存泄漏"></a></p>

<h2>Closure与内存管理、内存泄漏</h2>

<p>Closure带来的循环引用和内存泄漏，主要通过Capture List来解决：</p>

<blockquote><p>You resolve a strong reference cycle between a closure and a class instance by defining a capture list as part of the closure’s definition. A capture list defines the rules to use when capturing one or more reference types within the closure’s body.</p></blockquote>

<p>详细内容参考<a href="https://docs.swift.org/swift-book/LanguageGuide/AutomaticReferenceCounting.html#ID56">Resolving Strong Reference Cycles for Closures</a>。下面摘要一下。</p>

<p><a id="markdown-capture-list的定义" name="capture-list的定义"></a></p>

<h3>Capture List的定义</h3>

<blockquote><p>Each item in a capture list is a pairing of the weak or unowned keyword with a reference to a class instance (such as self) or a variable initialized with some value (such as delegate = self.delegate!). These pairings are written within a pair of square braces, separated by commas.</p></blockquote>

<p>Place the capture list before a closure’s parameter list and return type if they are provided:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>lazy var someClosure: (Int, String) -&gt; String = {
</span><span class='line'>    [unowned self, weak delegate = self.delegate!] (index: Int, stringToProcess: String) -&gt; String in
</span><span class='line'>    // closure body goes here
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><a id="markdown-weak-and-unowned-references" name="weak-and-unowned-references"></a></p>

<h3>Weak and Unowned References</h3>

<blockquote><p>Define a capture in a closure as an unowned reference when the closure and the instance it captures will always refer to each other, and will always be deallocated at the same time.</p>

<p>Conversely, define a capture as a weak reference when the captured reference may become nil at some point in the future. Weak references are always of an optional type, and automatically become nil when the instance they reference is deallocated. This enables you to check for their existence within the closure’s body.</p>

<p>NOTE: If the captured reference will never become nil, it should always be captured as an unowned reference, rather than a weak reference.</p></blockquote>

<p>关于unowned的另一个解释更清楚：</p>

<blockquote><p>Like a weak reference, an unowned reference does not keep a strong hold on the instance it refers to. Unlike a weak reference, however, an unowned reference is used when the other instance has the same lifetime or a longer lifetime.</p></blockquote>

<p><a id="markdown-closure捕获变量" name="closure捕获变量"></a></p>

<h2>Closure捕获变量</h2>

<blockquote><p>Closures can capture and store references to any constants and variables from the context in which they are defined. This is known as closing over those constants and variables.</p></blockquote>

<p>比如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// capturing values
</span><span class='line'>var i = 0
</span><span class='line'>var closureArray = [()-&gt;()]()
</span><span class='line'>for _ in 1...5 {
</span><span class='line'>    closureArray.append {
</span><span class='line'>        print(i)
</span><span class='line'>    }
</span><span class='line'>    i += 1
</span><span class='line'>}
</span><span class='line'>// here i will be 5
</span><span class='line'>closureArray[0]() // prints 5
</span><span class='line'>closureArray[1]() // prints 5
</span><span class='line'>closureArray[2]() // prints 5
</span><span class='line'>closureArray[3]() // prints 5
</span><span class='line'>closureArray[4]() // prints 5</span></code></pre></td></tr></table></div></figure>


<p>The closure captures the current address of <code>i</code> and every time we access <code>i</code> , it . returns the current value.</p>

<p>If we want to prevent this behavior (capturing values) and print the value of i even if the properties change after their capturing inside the closure, we can explicitly capture the variable with a capture list like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var closureArray2 = [()-&gt;()]()
</span><span class='line'>var j = 0
</span><span class='line'>for _ in 1...5 {
</span><span class='line'>    closureArray2.append { [j] in
</span><span class='line'>        print(j)
</span><span class='line'>    }
</span><span class='line'>    j += 1
</span><span class='line'>}
</span><span class='line'>// here i will be 5
</span><span class='line'>closureArray2[0]() // prints 0
</span><span class='line'>closureArray2[1]() // prints 1
</span><span class='line'>closureArray2[2]() // prints 2
</span><span class='line'>closureArray2[3]() // prints 3
</span><span class='line'>closureArray2[4]() // prints 4</span></code></pre></td></tr></table></div></figure>


<p>In this way, we keep an immutable copy of the variable <code>j</code>. Thanks to this copy, further changes to <code>j</code>, outside the closure, will not affect the closure. <code>j</code> is a let constant here. It is not mutable.</p>

<p>We can add multiple values to the capture list :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>closure.append { [j,k,l] in
</span><span class='line'>    print("\(j) \(k) \(l)")
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>also, you can have alias names for the values captured.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>closure.append { [a = j, b = k, c = l] in
</span><span class='line'>    print("\(a) \(b) \(c)")
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2024

    Zhang Hongchao


<!--Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>--></footer>
		</div>
	</div>
	










</body>
</html>
