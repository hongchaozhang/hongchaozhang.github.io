
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Offline Natural Language Understanding Engine on iOS - Reading Space</title>
	<meta name="author" content="Zhang Hongchao">

	
	<meta name="description" content="Offline Natural Language Understanding Engine on iOS Objective What is a good NLU engine Deterministic behavior
Generalization power Design and &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Reading Space" type="application/atom+xml">
	
	<link rel="canonical" href="http://hongchaozhang.github.io/blog/2019/05/22/offline-natural-language-understanding-engine-on-ios/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-62806905-2']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="/blog/archives">Archives</a></li>
    <li><a href="#">About</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		
		
			<a class="github" href="https://github.com/hongchaozhang" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>



<section class="categories">
          <ul id="category_cloud" class="nav nav-list"><a href='/blog/categories/algorithm' style='font-size: 101.33333333333333%'>algorithm(1)</a> <a href='/blog/categories/android' style='font-size: 108.0%'>android(6)</a> <a href='/blog/categories/android-studio' style='font-size: 101.33333333333333%'>android studio(1)</a> <a href='/blog/categories/augmented-reality' style='font-size: 105.33333333333333%'>augmented reality(4)</a> <a href='/blog/categories/css' style='font-size: 102.66666666666667%'>css(2)</a> <a href='/blog/categories/design-pattern' style='font-size: 104.0%'>design pattern(3)</a> <a href='/blog/categories/html' style='font-size: 102.66666666666667%'>html(2)</a> <a href='/blog/categories/html-css' style='font-size: 101.33333333333333%'>html css(1)</a> <a href='/blog/categories/http' style='font-size: 102.66666666666667%'>http(2)</a> <a href='/blog/categories/ios' style='font-size: 160.0%'>ios(45)</a> <a href='/blog/categories/java' style='font-size: 102.66666666666667%'>java(2)</a> <a href='/blog/categories/javascript' style='font-size: 105.33333333333333%'>javascript(4)</a> <a href='/blog/categories/machine-learning' style='font-size: 112.0%'>machine learning(9)</a> <a href='/blog/categories/map-tech' style='font-size: 104.0%'>map tech(3)</a> <a href='/blog/categories/mobile' style='font-size: 101.33333333333333%'>mobile(1)</a> <a href='/blog/categories/mongodb' style='font-size: 101.33333333333333%'>mongodb(1)</a> <a href='/blog/categories/music' style='font-size: 109.33333333333333%'>music(7)</a> <a href='/blog/categories/nlp' style='font-size: 102.66666666666667%'>nlp(2)</a> <a href='/blog/categories/nlu' style='font-size: 102.66666666666667%'>nlu(2)</a> <a href='/blog/categories/node' style='font-size: 104.0%'>node(3)</a> <a href='/blog/categories/nodejs' style='font-size: 104.0%'>nodejs(3)</a> <a href='/blog/categories/objective-c' style='font-size: 129.33333333333334%'>objective-c(22)</a> <a href='/blog/categories/philosophy' style='font-size: 102.66666666666667%'>philosophy(2)</a> <a href='/blog/categories/productivity' style='font-size: 130.66666666666666%'>productivity(23)</a> <a href='/blog/categories/python' style='font-size: 106.66666666666667%'>python(5)</a> <a href='/blog/categories/reading' style='font-size: 138.66666666666666%'>reading(29)</a> <a href='/blog/categories/server' style='font-size: 101.33333333333333%'>server(1)</a> <a href='/blog/categories/swift' style='font-size: 109.33333333333333%'>swift(7)</a> <a href='/blog/categories/web' style='font-size: 113.33333333333333%'>web(10)</a> <a href='/blog/categories/wwdc' style='font-size: 102.66666666666667%'>wwdc(2)</a> <a href='/blog/categories/xcode' style='font-size: 110.66666666666667%'>xcode(8)</a> </ul>
      </section>


</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Offline Natural Language Understanding Engine on iOS</h1>
	<div class="entry-content" itemprop="articleBody"><!-- more -->


<ul>
<li><a href="#objective">Objective</a>

<ul>
<li><a href="#what-is-a-good-nlu-engine">What is a good NLU engine</a>

<ul>
<li><a href="#deterministic-behavior">Deterministic behavior</a></li>
<li><a href="#generalization-power">Generalization power</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#design-and-workflow">Design and Workflow</a></li>
<li><a href="#deterministic-intent-parser">Deterministic Intent Parser</a></li>
<li><a href="#probabilistic-intent-parser">Probabilistic Intent Parser</a>

<ul>
<li><a href="#intent-classification">Intent Classification</a>

<ul>
<li><a href="#model-training">Model Training</a></li>
<li><a href="#model-usage">Model Usage</a></li>
</ul>
</li>
<li><a href="#slot-filling">Slot Filling</a>

<ul>
<li><a href="#model-training-1">Model Training</a></li>
<li><a href="#model-usage-1">Model Usage</a></li>
</ul>
</li>
<li><a href="#model-size">Model Size</a></li>
<li><a href="#problems-to-be-solved">Problems to Be Solved</a>

<ul>
<li><a href="#intent-classification-model-has-no-probability-output">Intent Classification Model Has No Probability Output</a></li>
<li><a href="#slot-filling-model-tagges-the-label-by-words-not-phrase">Slot Filling Model Tagges the Label by Words, not Phrase</a></li>
</ul>
</li>
</ul>
</li>
</ul>


<p><a id="markdown-objective" name="objective"></a></p>

<h2>Objective</h2>

<p><img src="/images/NLUObjective.png" alt="nlu objective" /></p>

<p>We want an NLU Engine to understand the normal text command on Mobile. We hope the engine can know the command&rsquo;s intent and the info the command needs to execute.</p>

<p>Currently, there are many NLU related tools, like Google Dialogflow, Amazon Lex, Facebook Wit.ai, Microsoft Luis. However, they are all online tools. Considering the privacy problem, we are trying to build our own offline NLU Engine.</p>

<p><a id="markdown-what-is-a-good-nlu-engine" name="what-is-a-good-nlu-engine"></a></p>

<h3>What is a good NLU engine</h3>

<p>Let’s start by looking at a simple example, and see what you would expect from a good NLU engine.</p>

<p>First, we need some examples to train the NLU engine. Consider the following dataset, used to train a simple weather assistant with a few query examples:</p>

<ul>
<li>Give me the weather for [tomorrow](date)</li>
<li>Show me the [Paris](location) weather for [Sunday](date)</li>
</ul>


<p><a id="markdown-deterministic-behavior" name="deterministic-behavior"></a></p>

<h4>Deterministic behavior</h4>

<p>The first thing you want is that all the examples you give to train the model are correctly supported by the engine. This makes the system predictable and easy to use: if a query is not correctly parsed, then add it to the dataset and it will work right away.</p>

<p><a id="markdown-generalization-power" name="generalization-power"></a></p>

<h4>Generalization power</h4>

<p>Having this deterministic behavior is great for robustness and predictability, but a powerful NLU engine also needs to have some generalization power. You want the system not only to recognize patterns provided in the training set, but also all the possible variations that come from speaking naturally. If we go back to the previous dataset, it is reasonable to expect the NLU engine to parse a query like: “What’s the weather in Beijing right now?” even though it is not one of the training examples.</p>

<p><a id="markdown-design-and-workflow" name="design-and-workflow"></a></p>

<h2>Design and Workflow</h2>

<p><img src="/images/NLUDesign.png" alt="nlu design" /></p>

<p>In order to satisfy these objectives: deterministic behavior and generalization power, we built the processing pipeline described in the figure above. It receives a text as input, and outputs a structured response containing the intent and the list of slots. The main processing unit of the pipeline is the NLU engine. It contains two intent parsers which are called successively: a deterministic intent parser and a probabilistic one.</p>

<p>The deterministic parser relies on regular expressions to match intent and slots, which results in perfect behavior on training examples but doesn’t generalize. This parser is the first to be used because of its strictness.</p>

<p>The probabilistic parser is used whenever the first parser fails to find a match. It uses machine learning to generalize beyond the set of sentences seen at train time, thus making our NLU engine be able to cope with examples which are not in the scope of the training data set. This parser involves two successive steps: intent classification and slot filling. These two steps rely on trained machine learning models to classify intent and extract slots.</p>

<p><a id="markdown-deterministic-intent-parser" name="deterministic-intent-parser"></a></p>

<h2>Deterministic Intent Parser</h2>

<p>The Deterministic Intent Parse is the first step to be used. This parser relies on some regular expressions to match the intent and slots. If the new input has the same structure with one of the training examples, we will find its intent and slots by comparing the input with the matched regular expression.</p>

<p>The regular expressions are built based on the training examples. For a training case:</p>

<ul>
<li>What is the weather in [Alaska](location)</li>
</ul>


<p>We will build a regular expression:</p>

<ul>
<li>(what is the weather in)(?&lt;location1&gt;.+)</li>
</ul>


<p><a id="markdown-probabilistic-intent-parser" name="probabilistic-intent-parser"></a></p>

<h2>Probabilistic Intent Parser</h2>

<p>If the Deterministic Intent Parser fails to find the intent and slots, the Probabilistic Intent Parser will be used.</p>

<p>The Probabilistic Intent Parser has two steps:</p>

<ul>
<li>Intent Classification</li>
<li>Slot Filling</li>
</ul>


<p>The Intent Classification is to find the intent of the input command text, and the Slot Filling is to extract all the slots needed by the intent. These two steps are both based on trained machine models.</p>

<p>Apple has released CreateML for training natural language models, which also integrates the powerful NatrualLanguage framework functions, like Tokenization, Part of Speech, Lemmatization, Name Entity Recognition, etc. This will make the training process very simple, and the trained model will be more accurate and smaller.</p>

<p><a id="markdown-intent-classification" name="intent-classification"></a></p>

<h3>Intent Classification</h3>

<p><a id="markdown-model-training" name="model-training"></a></p>

<h4>Model Training</h4>

<p>For Intent Classification model training, we prepare the data set as follows (The size of the training data is 3282 falling into four intents.):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">[</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;I would like the forecast in cupertino california  tomorrow&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;searchWeatherForecast&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Forecast in Maine USA next week&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;searchWeatherForecast&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'><span class="err">...</span>
</span><span class='line'><span class="err">...</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Will I be able to wear open-toed shoes twenty three hours and seven minutes from now in Severn?&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;searchWeatherForecastItem&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Should I bring a raincoat to the Belgrade and Loreto areas of Oman at midnight?&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;searchWeatherForecastItem&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'><span class="err">...</span>
</span><span class='line'><span class="err">...</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Apple has release CreateML framework for training machine learning models easily inside Swift playground and the trained model can be saved as mlmodel type. And the MLTextClassifier class from CreateML will benefit from Apple&rsquo;s NatrualLanguage framework for Tokenization, Part of Speech, Lemmatization, etc.</p>

<p>The training script is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">let</span> <span class="n">trainingDataPath</span> <span class="o">=</span> <span class="n">Bundle</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">path</span><span class="p">(</span><span class="nl">forResource</span><span class="p">:</span> <span class="s">&quot;intentClassificationFile&quot;</span><span class="p">,</span> <span class="nl">ofType</span><span class="p">:</span> <span class="s">&quot;json&quot;</span><span class="p">,</span> <span class="nl">inDirectory</span><span class="p">:</span> <span class="s">&quot;Data/text/train&quot;</span><span class="p">)</span><span class="o">!</span>
</span><span class='line'><span class="k">let</span> <span class="n">trainingData</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span> <span class="n">MLDataTable</span><span class="p">(</span><span class="nl">contentsOf</span><span class="p">:</span>  <span class="n">URL</span><span class="p">(</span><span class="nl">fileURLWithPath</span><span class="p">:</span> <span class="n">trainingDataPath</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Initializing the classifier with a training data.</span>
</span><span class='line'><span class="k">let</span> <span class="n">classifier</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span> <span class="n">MLTextClassifier</span><span class="p">(</span><span class="nl">trainingData</span><span class="p">:</span> <span class="n">trainingData</span><span class="p">,</span> <span class="nl">textColumn</span><span class="p">:</span> <span class="s">&quot;text&quot;</span><span class="p">,</span> <span class="nl">labelColumn</span><span class="p">:</span> <span class="s">&quot;label&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Evaluating training &amp; validation accuracies.</span>
</span><span class='line'><span class="k">let</span> <span class="n">trainingAccuracy</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">classifier</span><span class="p">.</span><span class="n">trainingMetrics</span><span class="p">.</span><span class="n">classificationError</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span class='line'><span class="k">let</span> <span class="n">validationAccuracy</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">classifier</span><span class="p">.</span><span class="n">validationMetrics</span><span class="p">.</span><span class="n">classificationError</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Initializing the properly labeled testing data from Resources folder.</span>
</span><span class='line'><span class="k">let</span> <span class="n">testingDataPath</span> <span class="o">=</span> <span class="n">Bundle</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">path</span><span class="p">(</span><span class="nl">forResource</span><span class="p">:</span> <span class="s">&quot;intentClassificationFile&quot;</span><span class="p">,</span> <span class="nl">ofType</span><span class="p">:</span> <span class="s">&quot;json&quot;</span><span class="p">,</span> <span class="nl">inDirectory</span><span class="p">:</span> <span class="s">&quot;Data/text/test&quot;</span><span class="p">)</span><span class="o">!</span>
</span><span class='line'><span class="k">let</span> <span class="n">testingData</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span> <span class="n">MLDataTable</span><span class="p">(</span><span class="nl">contentsOf</span><span class="p">:</span> <span class="n">URL</span><span class="p">(</span><span class="nl">fileURLWithPath</span><span class="p">:</span><span class="n">testingDataPath</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Counting the testing evaluation.</span>
</span><span class='line'><span class="k">let</span> <span class="n">evaluationMetrics</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">.</span><span class="n">evaluation</span><span class="p">(</span><span class="nl">on</span><span class="p">:</span> <span class="n">testingData</span><span class="p">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">evaluationAccuracy</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">evaluationMetrics</span><span class="p">.</span><span class="n">classificationError</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Confusion matrix in order to see which labels were classified wrongly.</span>
</span><span class='line'><span class="k">let</span> <span class="n">confusionMatrix</span> <span class="o">=</span> <span class="n">evaluationMetrics</span><span class="p">.</span><span class="n">confusion</span>
</span><span class='line'><span class="n">print</span><span class="p">(</span><span class="s">&quot;Confusion matrix: \(confusionMatrix)&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Metadata for saving the model.</span>
</span><span class='line'><span class="k">let</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">MLModelMetadata</span><span class="p">(</span><span class="nl">author</span><span class="p">:</span> <span class="s">&quot;Hongchao Zhang&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nl">shortDescription</span><span class="p">:</span> <span class="s">&quot;A model trained to classify weather related commands.&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nl">version</span><span class="p">:</span> <span class="s">&quot;1.0&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Saving the model. Remember to update the path.</span>
</span><span class='line'><span class="n">try</span><span class="o">!</span> <span class="n">classifier</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nl">to</span><span class="p">:</span> <span class="n">URL</span><span class="p">(</span><span class="nl">fileURLWithPath</span><span class="p">:</span> <span class="s">&quot;/Users/hozhang/Downloads/textClassifier.mlmodel&quot;</span><span class="p">),</span>
</span><span class='line'>                    <span class="nl">metadata</span><span class="p">:</span> <span class="n">metadata</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can get 99.23% training accuracy and 98.87% validation accuracy.</p>

<p><a id="markdown-model-usage" name="model-usage"></a></p>

<h4>Model Usage</h4>

<p>For the trained model of mlmodel type, we can use it in our iOS app through NLModel (from NatrualLanguage framework). The demo swift code may be like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">let</span> <span class="n">modelUrl</span> <span class="o">=</span> <span class="n">Bundle</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">url</span><span class="p">(</span><span class="nl">forResource</span><span class="p">:</span> <span class="s">&quot;Data/text/textClassifier&quot;</span><span class="p">,</span> <span class="nl">withExtension</span><span class="p">:</span> <span class="s">&quot;mlmodel&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">compiledModelUrl</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span> <span class="n">MLModel</span><span class="p">.</span><span class="n">compileModel</span><span class="p">(</span><span class="nl">at</span><span class="p">:</span> <span class="n">modelUrl</span><span class="o">!</span><span class="p">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">classifier</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span> <span class="n">NLModel</span><span class="p">(</span><span class="nl">contentsOf</span><span class="p">:</span> <span class="n">compiledModelUrl</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="n">requestText</span>
</span><span class='line'><span class="k">let</span> <span class="n">label</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">.</span><span class="n">predictedLabel</span><span class="p">(</span><span class="k">for</span><span class="o">:</span> <span class="n">text</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">print</span><span class="p">(</span><span class="s">&quot;text: \(text)</span><span class="se">\n</span><span class="s">label:\(label ?? &quot;</span><span class="n">Not</span> <span class="n">detected</span><span class="o">!</span><span class="s">&quot;)&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>How to use .mlmodel file?</strong></p>

<p>.mlmodel file needs to be compiled before using. There are two ways to do this: offline and online:</p>

<ol>
<li>offline: drag the mlmodel into your project, xcode will compile the .mlmodel for you before you build you app.</li>
<li>online: use <code>MLModel.compileModel</code> to compile your .mlmodel file at runtime. This is especially useful when your are at swift playground, where you cannot get xcode&rsquo;s help for comipling.</li>
</ol>
</blockquote>

<p><a id="markdown-slot-filling" name="slot-filling"></a></p>

<h3>Slot Filling</h3>

<p><a id="markdown-model-training-1" name="model-training-1"></a></p>

<h4>Model Training</h4>

<p>For Slot Filling model training, we prepare the data set as follows (The size of the training data is: 3282.):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">[</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;tokens&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;would&quot;</span><span class="p">,</span> <span class="s2">&quot;like&quot;</span><span class="p">,</span> <span class="s2">&quot;the&quot;</span><span class="p">,</span> <span class="s2">&quot;forecast&quot;</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="s2">&quot;california&quot;</span><span class="p">,</span> <span class="s2">&quot;tomorrow&quot;</span><span class="p">],</span>
</span><span class='line'>    <span class="nt">&quot;labels&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;tokens&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Forecast&quot;</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="s2">&quot;Maine&quot;</span><span class="p">,</span> <span class="s2">&quot;next week&quot;</span><span class="p">],</span>
</span><span class='line'>    <span class="nt">&quot;labels&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'><span class="err">...</span>
</span><span class='line'><span class="err">...</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Like Intent Classification model training, CreateML framework also makes it easy. Like MLTextClassifier, the MLWordTagger class from CreateML will also benefit from NatrualLanguage framework for Part of Speech, Lemmatization, Name Entity Recognition, etc.</p>

<p>The training script is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="c1">// Initializing the training data from Resources folder.</span>
</span><span class='line'><span class="k">let</span> <span class="n">trainingDataPath</span> <span class="o">=</span> <span class="n">Bundle</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">path</span><span class="p">(</span><span class="nl">forResource</span><span class="p">:</span> <span class="s">&quot;slotParsingFile&quot;</span><span class="p">,</span> <span class="nl">ofType</span><span class="p">:</span> <span class="s">&quot;json&quot;</span><span class="p">,</span> <span class="nl">inDirectory</span><span class="p">:</span> <span class="s">&quot;Data/text/train&quot;</span><span class="p">)</span><span class="o">!</span>
</span><span class='line'><span class="k">let</span> <span class="n">trainingData</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span> <span class="n">MLDataTable</span><span class="p">(</span><span class="nl">contentsOf</span><span class="p">:</span>  <span class="n">URL</span><span class="p">(</span><span class="nl">fileURLWithPath</span><span class="p">:</span> <span class="n">trainingDataPath</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Initializing the classifier with a training data.</span>
</span><span class='line'><span class="k">let</span> <span class="n">classifier</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span> <span class="n">MLWordTagger</span><span class="p">(</span><span class="nl">trainingData</span><span class="p">:</span> <span class="n">trainingData</span><span class="p">,</span> <span class="nl">tokenColumn</span><span class="p">:</span> <span class="s">&quot;tokens&quot;</span><span class="p">,</span> <span class="nl">labelColumn</span><span class="p">:</span> <span class="s">&quot;labels&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Evaluating training &amp; validation accuracies.</span>
</span><span class='line'><span class="k">let</span> <span class="n">trainingAccuracy</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">classifier</span><span class="p">.</span><span class="n">trainingMetrics</span><span class="p">.</span><span class="n">taggingError</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span class='line'><span class="k">let</span> <span class="n">validationAccuracy</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">classifier</span><span class="p">.</span><span class="n">validationMetrics</span><span class="p">.</span><span class="n">taggingError</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Initializing the properly labeled testing data from Resources folder.</span>
</span><span class='line'><span class="k">let</span> <span class="n">testingDataPath</span> <span class="o">=</span> <span class="n">Bundle</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">path</span><span class="p">(</span><span class="nl">forResource</span><span class="p">:</span> <span class="s">&quot;slotParsingFile&quot;</span><span class="p">,</span> <span class="nl">ofType</span><span class="p">:</span> <span class="s">&quot;json&quot;</span><span class="p">,</span> <span class="nl">inDirectory</span><span class="p">:</span> <span class="s">&quot;Data/text/test&quot;</span><span class="p">)</span><span class="o">!</span>
</span><span class='line'><span class="k">let</span> <span class="n">testingData</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span> <span class="n">MLDataTable</span><span class="p">(</span><span class="nl">contentsOf</span><span class="p">:</span> <span class="n">URL</span><span class="p">(</span><span class="nl">fileURLWithPath</span><span class="p">:</span><span class="n">testingDataPath</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Counting the testing evaluation.</span>
</span><span class='line'><span class="k">let</span> <span class="n">evaluationMetrics</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">.</span><span class="n">evaluation</span><span class="p">(</span><span class="nl">on</span><span class="p">:</span> <span class="n">testingData</span><span class="p">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">evaluationAccuracy</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">evaluationMetrics</span><span class="p">.</span><span class="n">taggingError</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Confusion matrix in order to see which labels were classified wrongly.</span>
</span><span class='line'><span class="k">let</span> <span class="n">confusionMatrix</span> <span class="o">=</span> <span class="n">evaluationMetrics</span><span class="p">.</span><span class="n">confusion</span>
</span><span class='line'><span class="n">print</span><span class="p">(</span><span class="s">&quot;Confusion matrix: \(confusionMatrix)&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Metadata for saving the model.</span>
</span><span class='line'><span class="k">let</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">MLModelMetadata</span><span class="p">(</span><span class="nl">author</span><span class="p">:</span> <span class="s">&quot;Hongchao Zhang&quot;</span><span class="p">,</span>
</span><span class='line'>                                <span class="nl">shortDescription</span><span class="p">:</span> <span class="s">&quot;A model trained to parse slots from weather related commands.&quot;</span><span class="p">,</span>
</span><span class='line'>                                <span class="nl">version</span><span class="p">:</span> <span class="s">&quot;1.0&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Saving the model. Remember to update the path.</span>
</span><span class='line'><span class="n">try</span><span class="o">!</span> <span class="n">classifier</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nl">to</span><span class="p">:</span> <span class="n">URL</span><span class="p">(</span><span class="nl">fileURLWithPath</span><span class="p">:</span> <span class="s">&quot;/Users/hozhang/Downloads/slotParsing.mlmodel&quot;</span><span class="p">),</span>
</span><span class='line'>                        <span class="nl">metadata</span><span class="p">:</span> <span class="n">metadata</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can get 99.64% training accuracy and 98.38% validation accuracy.</p>

<p><a id="markdown-model-usage-1" name="model-usage-1"></a></p>

<h4>Model Usage</h4>

<p>We can load the mlmodel into an NLTagger (from NatrualLanguage framework), and use the NLTagger to tag labels for each word of the input command text. The demo swift script is like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">let</span> <span class="n">weatherTagSchema</span> <span class="o">=</span> <span class="n">NLTagScheme</span><span class="p">(</span><span class="s">&quot;Weather&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">modelUrl</span> <span class="o">=</span> <span class="n">Bundle</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">url</span><span class="p">(</span><span class="nl">forResource</span><span class="p">:</span> <span class="s">&quot;Data/text/slotParsing&quot;</span><span class="p">,</span> <span class="nl">withExtension</span><span class="p">:</span> <span class="s">&quot;mlmodel&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">compiledModelUrl</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span> <span class="n">MLModel</span><span class="p">.</span><span class="n">compileModel</span><span class="p">(</span><span class="nl">at</span><span class="p">:</span> <span class="n">modelUrl</span><span class="o">!</span><span class="p">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">taggerModel</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span> <span class="n">NLModel</span><span class="p">(</span><span class="nl">contentsOf</span><span class="p">:</span> <span class="n">compiledModelUrl</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">weatherTagger</span> <span class="o">=</span> <span class="n">NLTagger</span><span class="p">(</span><span class="nl">tagSchemes</span><span class="p">:</span> <span class="p">[</span><span class="n">weatherTagSchema</span><span class="p">])</span>
</span><span class='line'><span class="n">weatherTagger</span><span class="p">.</span><span class="n">setModels</span><span class="p">([</span><span class="n">taggerModel</span><span class="p">],</span> <span class="nl">forTagScheme</span><span class="p">:</span> <span class="n">weatherTagSchema</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="n">requestText</span>
</span><span class='line'><span class="n">weatherTagger</span><span class="p">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">text</span>
</span><span class='line'><span class="n">weatherTagger</span><span class="p">.</span><span class="n">enumerateTags</span><span class="p">(</span><span class="k">in</span><span class="o">:</span> <span class="n">text</span><span class="p">.</span><span class="n">startIndex</span><span class="p">..</span><span class="o">&lt;</span><span class="n">text</span><span class="p">.</span><span class="n">endIndex</span><span class="p">,</span> <span class="nl">unit</span><span class="p">:</span> <span class="p">.</span><span class="n">word</span><span class="p">,</span> <span class="nl">scheme</span><span class="p">:</span> <span class="n">weatherTagSchema</span><span class="p">,</span> <span class="nl">options</span><span class="p">:</span> <span class="p">[])</span> <span class="p">{</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">tokenRange</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bool</span> <span class="k">in</span>
</span><span class='line'>    <span class="k">if</span> <span class="k">let</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">,</span> <span class="n">tag</span><span class="p">.</span><span class="n">rawValue</span> <span class="o">!=</span> <span class="s">&quot;Whitespace&quot;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">print</span><span class="p">(</span><span class="s">&quot;\(text[tokenRange]): \(tag.rawValue)&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">true</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong> Reference </strong></p>

<ol>
<li><a href="https://developer.apple.com/documentation/createml/creating_a_text_classifier_model">Creating a Text Classifier Model</a>: Apple offical site for training and using machine learning models through CreateML framework.</li>
<li>WWDC video <a href="https://developer.apple.com/videos/play/wwdc2018/713/">Introducing Natural Language Framework</a>: This session introduces NLP framework and its relation with CreateML framework.</li>
</ol>


<p><a id="markdown-model-size" name="model-size"></a></p>

<h3>Model Size</h3>

<p>For the iOS app, we hope the machine learning model size is small enough. Apple&rsquo;s NatrualLanguage framework has done many optimizations on machine learning model size. The following data is from WWDC 2018 (session 713: Introducing NatrualLanguage Framework):</p>

<table>
<thead>
<tr>
<th>&ndash; </th>
<th> Open Source CRFSuite </th>
<th> Natural Language Framework</th>
</tr>
</thead>
<tbody>
<tr>
<td>Name Entity Recognition </td>
<td> 70MB  </td>
<td> 1.4MB</td>
</tr>
<tr>
<td>Chunking </td>
<td> 30MB </td>
<td> 1.8MB</td>
</tr>
</tbody>
</table>


<p>We can see that the model will be much smaller than that trained from an open source platform.</p>

<p>The size of the two models we trained is (The training data size is: 3282):</p>

<table>
<thead>
<tr>
<th>Model </th>
<th> Size</th>
</tr>
</thead>
<tbody>
<tr>
<td>Intent Classification </td>
<td> 41K</td>
</tr>
<tr>
<td>Slot Filling </td>
<td> 609K</td>
</tr>
</tbody>
</table>


<p>If your model is a neural network, you can reduce the size of your model by the following way:
<a href="https://developer.apple.com/documentation/coreml/reducing_the_size_of_your_core_ml_app">Reducing the Size of Your Core ML App</a>. You can control the precision of the neural network parameters, and thus the size of the trained model.</p>

<p>If still your model is large, you can
<a href="https://developer.apple.com/documentation/coreml/core_ml_api/downloading_and_compiling_a_model_on_the_user_s_device">Downloading and Compiling a Model on the User&rsquo;s Device</a> at runtime.</p>

<p><a id="markdown-problems-to-be-solved" name="problems-to-be-solved"></a></p>

<h3>Problems to Be Solved</h3>

<p>For Probabilistic Intent Parser, we still have some problems.</p>

<p><a id="markdown-intent-classification-model-has-no-probability-output" name="intent-classification-model-has-no-probability-output"></a></p>

<h4>Intent Classification Model Has No Probability Output</h4>

<p>We may need the probability to define the reliability of the estimated intent of an input command text.</p>

<p>However, the model trained through <code>MLTextClassifier</code> has no probability output API. If we really need the probability output, we can use other platforms to train the model, like tensorflow. That way, we will not benefit from NatrualLanguage framework and we need to consider these things by ourselves, like Tokenization, Part of Speech, Lemmatization, etc.</p>

<blockquote><p>Try other tools for training models with probability output, like Turi.</p></blockquote>

<p><a id="markdown-slot-filling-model-tagges-the-label-by-words-not-phrase" name="slot-filling-model-tagges-the-label-by-words-not-phrase"></a></p>

<h4>Slot Filling Model Tagges the Label by Words, not Phrase</h4>

<p>The NLTagger class only supply the following four tag level: word, sentence, paragraph, and document. There is no &ldquo;phrase&rdquo; tag level. For example, &ldquo;New York&rdquo; will be treated as &ldquo;New&rdquo; and &ldquo;York&rdquo;, and the tagged label will both be &ldquo;location&rdquo;. We need to compose them together manually.</p>
</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2022

    Zhang Hongchao


<!--Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>--></footer>
		</div>
	</div>
	










</body>
</html>
