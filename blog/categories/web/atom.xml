<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: web | Reading Space]]></title>
  <link href="http://hongchaozhang.github.io/blog/categories/web/atom.xml" rel="self"/>
  <link href="http://hongchaozhang.github.io/"/>
  <updated>2025-06-10T18:27:41+08:00</updated>
  <id>http://hongchaozhang.github.io/</id>
  <author>
    <name><![CDATA[Zhang Hongchao]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Webæ€§èƒ½æŒ‡æ ‡]]></title>
    <link href="http://hongchaozhang.github.io/blog/2025/06/10/kpi-for-web-performance/"/>
    <updated>2025-06-10T17:51:04+08:00</updated>
    <id>http://hongchaozhang.github.io/blog/2025/06/10/kpi-for-web-performance</id>
    <content type="html"><![CDATA[<!-- more -->


<p>ä¸‹é¢æ˜¯Google Web Vitalsçš„æŒ‡æ ‡ï¼Œä»¥åŠå¦‚ä½•æµ‹é‡ã€‚</p>

<ul>
<li><a href="https://web.dev/articles/vitals">Web Vitals</a></li>
<li><a href="https://web.dev/articles/lcp#measure">Largest Contentful Paint (LCP)</a></li>
<li><a href="https://web.dev/articles/inp#how-to-measure-inp">Interaction to Next Paint (INP)</a></li>
<li><a href="https://web.dev/articles/cls#measure">Cumulative Layout Shift (CLS)</a></li>
</ul>


<p>ä¸‹é¢å¯¹å…¶è¿›è¡Œæ€»ç»“ã€‚</p>

<hr />

<h2>ğŸ” ä»€ä¹ˆæ˜¯ Web Vitalsï¼Ÿ</h2>

<ul>
<li><strong>Web Vitals</strong> æ˜¯ Google æ¨å‡ºçš„ç»Ÿä¸€æ€§èƒ½è¯„ä¼°ä½“ç³»ï¼Œæ—¨åœ¨è®©å¼€å‘è€…ã€äº§å“ç»ç†ç­‰èšç„¦ç•Œé¢ä½“éªŒè´¨é‡çš„æ ¸å¿ƒæŒ‡æ ‡ (<a href="https://web.dev/articles/vitals">web.dev</a>)ã€‚</li>
<li>å®ƒç®€åŒ–äº†æ€§èƒ½æŒ‡æ ‡ä½“ç³»ï¼Œèšç„¦å½“å‰"<strong>Core Web Vitals</strong>&ldquo;ï¼ˆæ ¸å¿ƒé¡µé¢ä½“éªŒæŒ‡æ ‡ï¼‰ (<a href="https://developers.google.com/search/docs/appearance/core-web-vitals">developers.google.com</a>)ã€‚</li>
</ul>


<hr />

<h2>ğŸ¯ Core Web Vitals ä¸»è¦æŒ‡æ ‡</h2>

<p><img src="/images/LCP-INP-CLS.jpg" alt="lcp inp cls" /></p>

<p>è¿™ä¸‰ä¸ªæŒ‡æ ‡åæ˜ äº†ç”¨æˆ·ä½“éªŒçš„ä¸‰ä¸ªå…³é”®ç»´åº¦ï¼š</p>

<table>
<thead>
<tr>
<th> æŒ‡æ ‡                              </th>
<th> æè¿°                     </th>
<th> ä¼˜è‰¯é˜ˆå€¼                   </th>
</tr>
</thead>
<tbody>
<tr>
<td> LCP (Largest Contentful Paint)  </td>
<td> æœ€å¤§å†…å®¹å…ƒç´ é¦–æ¬¡å¯¹ç”¨æˆ·å¯è§æ‰€éœ€æ—¶é—´      </td>
<td> â‰¤ 2.5 s (<a href="https://web.dev/articles/vitals">web.dev</a>) </td>
</tr>
<tr>
<td> INP (Interaction to Next Paint) </td>
<td> ç”¨æˆ·äº¤äº’è‡³ä¸‹ä¸€å¸§æ¸²æŸ“å®Œæˆçš„å»¶è¿Ÿï¼Œåæ˜ å“åº”é€Ÿåº¦ </td>
<td> â‰¤ 200 ms               </td>
</tr>
<tr>
<td> CLS (Cumulative Layout Shift)   </td>
<td> é¡µé¢å…ƒç´ æ„å¤–ç§»åŠ¨å¼•èµ·çš„è§†è§‰ç¨³å®šæ€§é—®é¢˜ç´¯ç§¯åˆ†æ•° </td>
<td> â‰¤ 0.1                  </td>
</tr>
</tbody>
</table>


<ul>
<li>è¡¡é‡æ ‡å‡†é‡‡ç”¨ <strong>75th percentile</strong>ï¼Œä¹Ÿå°±æ˜¯å¤§å¤šæ•°ç”¨æˆ·ï¼ˆå‰ 75%ï¼‰ä½“éªŒåº”æ»¡è¶³ä¸Šè¿°é˜ˆå€¼ (<a href="https://web.dev/articles/vitals">web.dev</a>)ã€‚</li>
<li>é•¿æœŸæ¥çœ‹ï¼ŒCore Web Vitals æŒ‡æ ‡å¯èƒ½ä¼šéšç€ç ”ç©¶æ¼”è¿›è°ƒæ•´ï¼ˆç›®å‰ç”±å®éªŒâ†’å¾…å®šâ†’ç¨³å®šé˜¶æ®µç®¡ç†ï¼‰ ã€‚</li>
</ul>


<hr />

<h2>ğŸ›  å¦‚ä½•è¡¡é‡ Web Vitals</h2>

<ul>
<li><strong>åˆæˆå·¥å…·</strong>ï¼šLighthouseã€WebPageTestã€Chrome DevTools Performance é¢æ¿ï¼ˆæ”¯æŒå®æ—¶æµ‹é‡ FCIã€LCPã€CLSã€INPï¼‰ (<a href="https://web.dev/performance">web.dev</a>)ã€‚</li>
<li><p><strong>çœŸå®ç”¨æˆ·ç›‘æ§</strong>ï¼š</p>

<ul>
<li>ä½¿ç”¨ <code>web-vitals</code> JS åº“é‡‡é›†ã€ä¸ŠæŠ¥ï¼ˆå¯é…åˆ GA4ã€BigQueryï¼‰(<a href="https://web.dev/articles/vitals-ga4">web.dev</a>)ï¼›</li>
<li>æˆ–ä½¿ç”¨ç°æˆ RUM å·¥å…·ï¼Œå¦‚ Google Analyticsã€CrUXã€Search Console Core Web Vitals æŠ¥å‘Šç­‰ (<a href="https://web.dev/articles/vitals-ga4">web.dev</a>)ã€‚</li>
</ul>
</li>
</ul>


<hr />

<h2><a href="https://web.dev/articles/lcp#measure">Largest Contentful Paint (LCP)</a></h2>

<h3>1. ä»€ä¹ˆæ˜¯ LCPï¼Ÿ</h3>

<ul>
<li><strong>LCP</strong> æŒ‡çš„æ˜¯æµè§ˆå™¨é¦–æ¬¡æ¸²æŸ“é¡µé¢ä¸­ <strong>æœ€å¤§å†…å®¹å…ƒç´ </strong>ï¼ˆå¦‚å›¾ç‰‡å—ã€æ–‡æœ¬å—æˆ–è§†é¢‘ï¼‰çš„æ—¶é—´ï¼Œç›¸å¯¹äºé¡µé¢å¼€å§‹åŠ è½½æ—¶åˆ»(<a href="https://web.dev/articles/lcp?utm_source=chatgpt.com">web.dev</a>)ã€‚</li>
<li>å®ƒæ˜¯ Core Web Vitals ä¸­è¡¡é‡â€œé¡µé¢ä¸»è¦å†…å®¹æ˜¯å¦å¿«é€Ÿå¯è§â€çš„å…³é”®æŒ‡æ ‡ï¼Œæ¯”ä¼ ç»ŸæŒ‡æ ‡ï¼ˆå¦‚ FCPã€DOMContentLoadedï¼‰æ›´èƒ½è´´åˆç”¨æˆ·æ„ŸçŸ¥(<a href="https://web.dev/articles/lcp?hl=ja&amp;utm_source=chatgpt.com">web.dev</a>)ã€‚</li>
<li>LCPè¢«è®¤ä¸ºæ˜¯æœ€æ¥è¿‘â€œé¦–å±æ¸²æŸ“æ—¶é—´â€çš„æŒ‡æ ‡ã€‚</li>
</ul>


<h3>2. è€ƒé‡å…ƒç´ ä¸è§„åˆ™</h3>

<ul>
<li>LCP åªè€ƒè™‘ç‰¹å®šç±»å‹å…ƒç´ ã€‚</li>
<li>åªè®¡ç®—å¯è§éƒ¨åˆ†</li>
</ul>


<p>ä¸‹é¢æ˜¯å‡ ä¸ªLCPçš„ä¾‹å­ã€‚</p>

<p><img src="/images/lcp-demo1.png" alt="lcp demo 1" /></p>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ–°å†…å®¹è¢«æ·»åŠ åˆ°DOMä¸­ï¼Œè¿™æ”¹å˜äº†å“ªä¸ªå…ƒç´ æ˜¯æœ€å¤§çš„ã€‚</p>

<p><img src="/images/lcp-demo-2.png" alt="lcp demo 2" /></p>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒInstagramçš„logoç›¸å¯¹è¾ƒæ—©åŠ è½½ï¼Œå³ä½¿å…¶ä»–å†…å®¹é€æ¸æ˜¾ç¤ºï¼Œå®ƒä»ç„¶æ˜¯æœ€å¤§çš„å…ƒç´ ã€‚</p>

<p><img src="/images/lcp-demo-3.png" alt="lcp demo 3" /></p>

<p>åœ¨è¿™ä¸ªGoogleæœç´¢ç»“æœé¡µé¢çš„ä¾‹å­ä¸­ï¼Œæœ€å¤§çš„å…ƒç´ æ˜¯ä¸€æ®µæ–‡æœ¬ï¼Œå®ƒåœ¨ä»»ä½•å›¾åƒæˆ–logoåŠ è½½å®Œæˆä¹‹å‰å°±æ˜¾ç¤ºå‡ºæ¥äº†ã€‚ç”±äºæ‰€æœ‰å•ç‹¬çš„å›¾åƒéƒ½æ¯”è¿™æ®µæ–‡æœ¬å°ï¼Œæ‰€ä»¥åœ¨æ•´ä¸ªåŠ è½½è¿‡ç¨‹ä¸­å®ƒå§‹ç»ˆæ˜¯æœ€å¤§çš„å…ƒç´ ã€‚</p>

<hr />

<h2><a href="https://web.dev/articles/inp#how-to-measure-inp">Interaction to Next Paint (INP)</a></h2>

<h3>ğŸ¯ ä»€ä¹ˆæ˜¯ INPï¼Ÿ</h3>

<ul>
<li><strong>INP</strong> æ˜¯ Core Web Vitals çš„ä¸€é¡¹ç¨³å®šæŒ‡æ ‡ï¼Œç”¨æ¥è¯„ä¼°é¡µé¢å¯¹ç”¨æˆ·æ‰€æœ‰äº¤äº’ï¼ˆç‚¹å‡»ã€è§¦æ‘¸ã€é”®ç›˜è¾“å…¥ç­‰ï¼‰çš„æ•´ä½“å“åº”èƒ½åŠ›ã€‚</li>
<li>å®ƒä¼šè®°å½•æ•´ä¸ªé¡µé¢ç”Ÿå‘½å‘¨æœŸä¸­çš„æ¯æ¬¡äº¤äº’å»¶è¿Ÿï¼Œæœ€ç»ˆä»¥ <strong>æœ€é•¿çš„é‚£æ¬¡äº¤äº’</strong>ï¼ˆå‰”é™¤æç«¯å€¼ï¼‰ä½œä¸ºè¯¥é¡µé¢çš„ INP åˆ†æ•°ã€‚</li>
</ul>


<h3>ğŸ”„ ä¸ºä»€ä¹ˆç”¨ INP æ›¿ä»£ FIDï¼Ÿ</h3>

<ul>
<li><strong>FIDï¼ˆFirst Input Delayï¼‰</strong> åªæµ‹é‡é¡µé¢é¦–æ¬¡äº¤äº’çš„å»¶è¿Ÿï¼Œè€Œ INP æ›´å…¨é¢ï¼Œè¡¡é‡æ•´ä¸ªè®¿é—®è¿‡ç¨‹ä¸­çš„æ‰€æœ‰äº¤äº’å»¶è¿Ÿï¼Œæ›´çœŸå®åæ˜ ç”¨æˆ·ä½“éªŒã€‚</li>
<li>INP åŒ…æ‹¬ä»ç”¨æˆ·è¾“å…¥ã€äº‹ä»¶å¤„ç†åˆ°ä¸‹ä¸€å¸§</li>
</ul>


<h3>ğŸ§ª å¦‚ä½•æµ‹é‡ INPï¼Ÿ</h3>

<p>ä½¿ç”¨ <code>web-vitals</code> JavaScript åº“æµ‹é‡ INPã€‚</p>

<h3>ğŸ›  æé«˜ INP çš„å¸¸è§ä¼˜åŒ–æªæ–½</h3>

<ol>
<li>é¿å…ä¸»çº¿ç¨‹é•¿æ—¶é—´é˜»å¡ï¼ˆæ¯”å¦‚å¤§å¾ªç¯æˆ–åŒæ­¥ JSï¼‰ã€‚</li>
<li>å°†é‡é€»è¾‘æ‹†åˆ†ä¸ºå¼‚æ­¥ä»»åŠ¡ï¼ˆå¦‚ requestIdleCallbackã€setTimeoutï¼‰ã€‚</li>
<li>å‡å°‘ç¬¬ä¸‰æ–¹è„šæœ¬å¹²æ‰°ã€‚</li>
<li>å»¶è¿ŸåŠ è½½ä¸é‡è¦çš„èµ„æºï¼ˆå¦‚å›¾ç‰‡ã€iframeï¼‰ã€‚</li>
<li>ä½¿ç”¨ <code>content-visibility: auto</code> ä¼˜åŒ–é¦–æ¬¡ç»˜åˆ¶åŒºåŸŸã€‚</li>
</ol>


<hr />

<h2><a href="https://web.dev/articles/cls#measure">Cumulative Layout Shift (CLS)</a></h2>

<h3>ğŸ§© ä»€ä¹ˆæ˜¯ CLSï¼Ÿ</h3>

<ul>
<li><strong>CLSï¼ˆCumulative Layout Shiftï¼‰</strong> æ¸¬é‡çš„æ˜¯é¡µé¢åœ¨éç”¨æˆ·è§¦å‘çš„æƒ…å†µä¸‹ï¼Œè§†è§‰å†…å®¹å‘ç”Ÿçš„æ„å¤–ä½ç§»ç´¯ç§¯ç¨‹åº¦ï¼Œæ˜¯ Core Web Vitals çš„ä¸€é¡¹é‡è¦ç¨³å®šæŒ‡æ ‡ ([web.dev][1])ã€‚</li>
<li>ä¸€æ¬¡å¸ƒå±€ç§»åŠ¨ï¼ˆlayout shiftï¼‰æŒ‡çš„æ˜¯åœ¨ä¸¤ä¸ªç»˜åˆ¶å¸§ä¹‹é—´ï¼Œä¸€ä¸ªå¯è§å…ƒç´ çš„ä½ç½®æ”¹å˜ã€‚è‹¥å¤šä¸ªè¿™ç§å˜åŒ–è¿ç»­å‘ç”Ÿï¼ˆé—´éš” &lt; 1 ç§’ï¼Œæ€»æ—¶é•¿ â‰¤ 5 ç§’ï¼‰ï¼Œå®ƒä»¬å½¢æˆä¸€ä¸ªå¸ƒå±€ç§»åŠ¨â€œçªå‘çª—å£â€ï¼ˆsession windowï¼‰ï¼ŒCLS å–è¯¥çª—å£é‡Œå¾—åˆ†æœ€é«˜çš„ä¸€ç»„å˜åŒ– ([web.dev][1])ã€‚</li>
</ul>


<hr />

<h3>ğŸ“Š å¦‚ä½•è®¡ç®—å¸ƒå±€ç§»åŠ¨åˆ†æ•°ï¼Ÿ</h3>

<p>æ¯æ¬¡ layoutâ€‘shift æ¡ç›®çš„åˆ†æ•°ç”±ä¸‹é¢ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p>

<ol>
<li><strong>impact fraction</strong>ï¼šä¸ç¨³å®šå…ƒç´ çš„å½±å“åŒºåŸŸå è§†å£å¤§å°çš„æ¯”ä¾‹ã€‚</li>
<li><strong>distance fraction</strong>ï¼šå…ƒç´ ç§»åŠ¨è·ç¦»å è§†å£æœ€å¤§è¾¹é•¿ï¼ˆå®½æˆ–é«˜ï¼‰çš„æ¯”ä¾‹ã€‚</li>
</ol>


<h3>ğŸ§ª å¦‚ä½•æµ‹é‡ CLSï¼Ÿ</h3>

<h4>å®éªŒå®¤å·¥å…·ï¼ˆåˆæˆç¯å¢ƒï¼‰ï¼š</h4>

<ul>
<li>Chrome DevToolsã€Lighthouseã€PageSpeed Insightsã€WebPageTest éƒ½å¯æµ‹é‡åŠ è½½è¿‡ç¨‹ä¸­çš„ CLS å€¼ã€‚</li>
</ul>


<h4>çœŸå®ç”¨æˆ·ç›‘æ§ï¼ˆField Dataï¼‰ï¼š</h4>

<ul>
<li>ä½¿ç”¨ CrUXã€Search Consoleã€PageSpeed Insights RUM ç­‰ï¼›</li>
<li>æ¨èé€šè¿‡ <code>web-vitals</code> æˆ– Layout Instability API æ•è·äº‹ä»¶å¹¶ä¸ŠæŠ¥</li>
</ul>


<h3>ğŸ›  å¦‚ä½•ä¼˜åŒ– CLSï¼Ÿ</h3>

<ul>
<li><strong>æ˜¾å¼æŒ‡å®šèµ„æºå°ºå¯¸</strong>ï¼šç»™å›¾ç‰‡ã€è§†é¢‘ã€iframe è®¾ç½® <code>width/height</code> æˆ–ä½¿ç”¨ CSS aspect-ratioï¼Œé¿å…åŠ è½½åæ¨ç§»ã€‚</li>
<li><strong>å…ˆå ä½ååŠ è½½</strong>ï¼šå¼‚æ­¥åŠ è½½èµ„æºå‰é¢„ç•™ç©ºé—´ï¼ˆä¾‹å¦‚å¹¿å‘Šã€è¿œç¨‹ç»„ä»¶ï¼‰ï¼ŒåŠ è½½åä¸å¼•èµ·å¸ƒå±€ç§»åŠ¨ã€‚</li>
<li><strong>é€‚åº¦åŠ¨ç”»è¿‡æ¸¡</strong>ï¼šç”¨ CSS <code>transform</code> åŠ¨ç”»ä»£æ›¿çªå…€çš„å¸ƒå±€å˜åŒ–ï¼Œè‹¥ä¸ç”¨æˆ·äº¤äº’è§¦å‘å¯æ’é™¤è®¡ç®—ã€‚</li>
<li><strong>ç¬¬ä¸‰æ–¹è„šæœ¬æ³¨æ„å°ºå¯¸</strong>ï¼šå¹¿å‘Šã€embed å†…å®¹åº”æä¾›å›ºå®šé«˜åº¦/å®½åº¦ï¼›è‹¥åŠ¨æ€å˜åŒ–ï¼Œåº”ç”¨åŠ¨ç”»æˆ–é¢„ç•™é•¿æ¡æç¤ºã€‚</li>
<li><strong>è¿‡æ»¤ç”¨æˆ·äº¤äº’è§¦å‘ç§»åŠ¨</strong>ï¼š500ms å†…å…³è”ç”¨æˆ·äº¤äº’çš„ layout shift ä¸è®¡å…¥ CLSï¼ˆä¾‹å¦‚ç‚¹å‡»å±•å¼€ï¼‰ã€‚</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[æ€æ ·æé«˜webæ€§èƒ½]]></title>
    <link href="http://hongchaozhang.github.io/blog/2025/06/10/how-to-improve-web-performance/"/>
    <updated>2025-06-10T16:57:17+08:00</updated>
    <id>http://hongchaozhang.github.io/blog/2025/06/10/how-to-improve-web-performance</id>
    <content type="html"><![CDATA[<!-- more -->


<p>ä¸‹é¢æ˜¯GPTæ€»ç»“çš„webæ€§èƒ½ä¼˜åŒ–ï¼Œæˆ‘æ•´ç†äº†ä¸€ä¸‹ï¼Œæ–¹ä¾¿è‡ªå·±é˜…è¯»ã€‚</p>

<p>ä»¥ä¸‹å†…å®¹åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šä¸€æ˜¯åˆ†ææ€è·¯ä¸æµç¨‹ï¼ŒäºŒæ˜¯å¸¸ç”¨å·¥å…·æ¨èï¼Œä¸‰æ˜¯Chrome DevTools ä¸­å‡ ä¸ªå¸¸ç”¨ä¸”å¥½ç”¨çš„åŠŸèƒ½ç¤ºä¾‹ã€‚</p>

<hr />

<h2>ä¸€ã€åˆ†ææ€è·¯ä¸æµç¨‹</h2>

<ol>
<li><p><strong>æ˜ç¡®æ€§èƒ½ç›®æ ‡ä¸è¡¡é‡æŒ‡æ ‡</strong></p>

<ul>
<li>æ˜ç¡®â€œæ€§èƒ½â€ï¼š

<ul>
<li>é¡µé¢é¦–æ¬¡å¯äº¤äº’ï¼ˆFirst Contentful Paintï¼‰</li>
<li>é¦–å±æ¸²æŸ“æ—¶é—´ï¼ˆTime to First Byteã€First Paintã€First Meaningful Paintï¼‰</li>
<li>å¯äº¤äº’æ—¶é—´ï¼ˆTime to Interactiveï¼‰</li>
<li>æ•´ä½“åŠ è½½å®Œæˆæ—¶é—´ï¼ˆLoad Event Endï¼‰</li>
</ul>
</li>
<li>ç»“åˆä¸šåŠ¡éœ€æ±‚ï¼Œç¡®å®šç”¨æˆ·ä½“éªŒæœ€å…³å¿ƒçš„å…³é”®æŒ‡æ ‡ï¼ˆKPIï¼‰ï¼Œå¦‚ï¼š

<ul>
<li>é¦–å±åŠ è½½æ—¶é—´ &lt; 2s</li>
<li>é¦–ä¸ªè¾“å…¥å»¶è¿Ÿï¼ˆFIDï¼‰&lt; 100ms</li>
<li>ç´¯è®¡å¸ƒå±€åç§»ï¼ˆCLSï¼‰&lt; 0.1</li>
</ul>
</li>
<li>åŸºäºè¿™äº›æŒ‡æ ‡ï¼Œæ‰èƒ½æœ‰çš„æ”¾çŸ¢åœ°å»å®šä½ç“¶é¢ˆã€‚</li>
</ul>
</li>
<li><p><strong>æ”¶é›†åˆæ­¥çš„æ€§èƒ½æ•°æ®ï¼ˆåŸºçº¿æµ‹é‡ï¼‰</strong></p>

<ul>
<li>é€šè¿‡ Lighthouseã€WebPageTestã€Chrome DevTools è‡ªå¸¦çš„ Performance é¢æ¿ç­‰å·¥å…·ï¼Œå…ˆè·‘ä¸€æ¬¡å®Œæ•´çš„æµ‹é€Ÿï¼ŒæŠŠå¾—å‡ºçš„å„é¡¹æŒ‡æ ‡ï¼ˆTTFBã€FCPã€LCPã€TTIã€Total Blocking Timeã€Overall Load Timeã€èµ„æºå¤§å°ç»Ÿè®¡ç­‰ï¼‰è®°å½•ä¸‹æ¥ï¼Œä½œä¸ºåç»­ä¼˜åŒ–å‰åçš„å¯¹æ¯”åŸºçº¿ã€‚</li>
<li>ä¹Ÿå¯ä»¥æ¥å…¥ RUMï¼ˆReal User Monitoringï¼‰ç³»ç»Ÿï¼Œæ¯”å¦‚ Google Analyticsã€Sentry Performanceã€New Relic Browserï¼Œæ”¶é›†çœŸå®ç”¨æˆ·åœ¨ä¸åŒç½‘ç»œç¯å¢ƒï¼ˆ4Gã€3Gã€å®½å¸¦ï¼‰ä¸‹çš„åŠ è½½æƒ…å†µã€‚</li>
</ul>
</li>
<li><p><strong>æ·±å…¥åˆ†æå„é¡¹è€—æ—¶æ˜ç»†</strong></p>

<ul>
<li><strong>ç½‘ç»œè¯·æ±‚åˆ†æ</strong>ï¼šæŸ¥çœ‹èµ„æºè¯·æ±‚çš„æ•°é‡ã€æŒ‰åŸŸååˆ†ç»„å¤§å°ã€ç¼“å­˜å‘½ä¸­ç‡ã€æ˜¯å¦å­˜åœ¨å¤šä½™çš„ç¬¬ä¸‰æ–¹è„šæœ¬ï¼›å…³æ³¨é˜»å¡ï¼ˆBlockingï¼‰ã€æ’é˜Ÿï¼ˆQueuingï¼‰å’Œä¼ è¾“ï¼ˆTransferï¼‰æ—¶é•¿ã€‚</li>
<li><strong>JavaScript æ‰§è¡Œåˆ†æ</strong>ï¼šåˆ†æè„šæœ¬è§£æä¸ç¼–è¯‘ã€å‡½æ•°æ‰§è¡Œã€é•¿ä»»åŠ¡ï¼ˆLong Tasksï¼‰ã€‚å¦‚<em>æœ‰å¤§é‡ä¸»çº¿ç¨‹é˜»å¡</em>ã€é•¿ä»»åŠ¡ä¼šé˜»å¡æ¸²æŸ“æˆ–ç”¨æˆ·äº¤äº’ï¼Œéœ€è¦è€ƒè™‘æ‹†åˆ† Webpack bundleã€é‡‡ç”¨ <em>Code Splitting</em>ã€<em>æ‡’åŠ è½½</em>ã€‚</li>
<li><strong>æ¸²æŸ“ä¸å¸ƒå±€</strong>ï¼šæŸ¥çœ‹æ˜¯å¦å­˜åœ¨<em>å¼ºåˆ¶åŒæ­¥å¸ƒå±€ï¼ˆForced Reflowï¼‰</em>ã€é¢‘ç¹çš„ DOM æ“ä½œå¯¼è‡´å¸ƒå±€æŠ–åŠ¨ï¼Œæ˜¯å¦å­˜åœ¨å¤§é¢ç§¯çš„ repaintã€‚</li>
<li><strong>èµ„æºåŠ è½½ä¼˜å…ˆçº§</strong>ï¼šè¯„ä¼°å…³é”® CSS/JS æ˜¯å¦åˆç† inline æˆ–é¢„åŠ è½½ï¼Œå›¾ç‰‡æ˜¯å¦åšäº†æ‡’åŠ è½½ã€å°ºå¯¸å‹ç¼©ï¼Œä»¥åŠå­—ä½“åŠ è½½ç­–ç•¥ï¼ˆfont-displayï¼‰æ˜¯å¦åˆç†ã€‚</li>
</ul>
</li>
<li><p><strong>å®šä½ç“¶é¢ˆå¹¶åˆ†ç±»ä¼˜åŒ–æ–¹æ¡ˆ</strong></p>

<ul>
<li><p><strong>ç½‘ç»œå±‚é¢</strong></p>

<ul>
<li>åˆå¹¶æˆ–æ‹†åˆ†è¯·æ±‚ï¼šå°†å¤šä¸ªå°é™æ€èµ„æºåˆå¹¶ä¸ºä¸€ä¸ªåŒ…ï¼ˆæˆ–åä¹‹ï¼Œæ‹†åˆ†è¾ƒå¤§çš„åŒ…ä¸ºæŒ‰éœ€åŠ è½½ï¼‰ï¼›</li>
<li>å¯ç”¨ HTTP/2 æˆ– HTTP/3ï¼Œå‡å°æ¡æ‰‹ä¸é˜Ÿå¤´é˜»å¡ï¼ˆHead-of-line Blockingï¼‰ï¼›</li>
<li>æ ¸æŸ¥ç¼“å­˜ç­–ç•¥ï¼ˆCache-Controlã€ETagï¼‰ï¼Œç¡®ä¿é™æ€èµ„æºåœ¨å®¢æˆ·ç«¯å¯å¤ç”¨ï¼›</li>
<li>å¼€å¯ Gzip æˆ– Brotli å‹ç¼©ï¼›</li>
<li>ç¡®è®¤ CDN è¦†ç›–ä¸èŠ‚ç‚¹å°±è¿‘åˆ†å‘ã€‚</li>
</ul>
</li>
<li><p><strong>ä»£ç åŒ…ä½“ç§¯</strong></p>

<ul>
<li>ä½¿ç”¨ Tree Shakingã€ä»£ç åˆ†å‰²ï¼ˆCode Splittingï¼‰ã€æŒ‰éœ€åŠ è½½ï¼ˆdynamic importï¼‰ï¼›</li>
<li>åˆ é™¤ä¸å¿…è¦çš„ polyfillã€ç¬¬ä¸‰æ–¹åº“é‡Œä¸ä½¿ç”¨çš„åŠŸèƒ½ï¼›</li>
<li>å‹ç¼©æ··æ·† JS/CSSï¼ˆTerserã€CSSNanoï¼‰ã€‚</li>
</ul>
</li>
<li><p><strong>å›¾ç‰‡ä¸å¤šåª’ä½“èµ„æº</strong></p>

<ul>
<li>å›¾ç‰‡å‹ç¼©ï¼ˆWebPã€AVIFï¼‰ï¼Œä½¿ç”¨åˆé€‚çš„åˆ†è¾¨ç‡ï¼›</li>
<li>å›¾ç‰‡æ‡’åŠ è½½ï¼ˆIntersection Observer APIï¼‰ï¼›</li>
<li>Sprite å›¾åˆå¹¶é™æ€å°å›¾æ ‡ï¼Œå°½é‡å‡å°‘ HTTP è¯·æ±‚ã€‚

<ul>
<li>ä¹Ÿä¸ä¸€å®šã€‚å¦‚æœå¯ç”¨ HTTP/2 æˆ– HTTP/3ï¼Œå¹¶è¡Œèƒ½åŠ›å¢å¼ºï¼Œåˆå¹¶è¯·æ±‚åè€Œä¼šé™ä½æ€§èƒ½ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>æ¸²æŸ“ä¸äº¤äº’</strong></p>

<ul>
<li>å‡å°‘æ— æ„ä¹‰çš„ DOM æ“ä½œï¼Œé¿å…é¢‘ç¹è¯»å†™ DOMï¼›</li>
<li>é¿å…åŒæ­¥å¸ƒå±€ã€å¼ºåˆ¶å›æµï¼Œåˆç†ä½¿ç”¨ requestAnimationFrameï¼›</li>
<li>ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨ï¼ˆVirtual Listï¼‰å¤„ç†é•¿åˆ—è¡¨ã€‚</li>
</ul>
</li>
<li><p><strong>ç¬¬ä¸‰æ–¹è„šæœ¬</strong></p>

<ul>
<li>å®šæœŸå®¡æŸ¥åŸ‹ç‚¹ / ç›‘æ§ / å¹¿å‘Š / ç¤¾äº¤æ’ä»¶ï¼Œç§»é™¤æˆ–å»¶è¿ŸåŠ è½½å†—ä½™è„šæœ¬ï¼›</li>
<li>å°†ä¸å½±å“é¦–å±æ¸²æŸ“çš„ç¬¬ä¸‰æ–¹è„šæœ¬æ ‡è®°ä¸º <code>async</code> æˆ– <code>defer</code>ï¼Œæˆ–æ”¾åœ¨é¡µé¢åº•éƒ¨ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>éªŒè¯å’Œè¿­ä»£</strong></p>

<ul>
<li>æ¯åšä¸€æ­¥ä¼˜åŒ–ï¼Œéƒ½è¦é‡æ–°æ”¶é›† Performance æŒ‡æ ‡ï¼Œä¸åŸºçº¿åšå¯¹æ¯”ï¼›</li>
<li>å€ŸåŠ© Lighthouseã€CI/CD ä¸­çš„è‡ªåŠ¨åŒ–æ£€æµ‹å·¥å…·ï¼ˆå¦‚ GitHub Action + Lighthouse CIï¼‰æŒç»­ç›‘æ§ï¼›</li>
<li>å¯¹æ¯”çœŸå®ç”¨æˆ·æ•°æ®ï¼ˆRUMï¼‰ï¼Œé¿å…â€œåˆæˆæµ‹è¯•æŒ‡æ ‡å¾ˆå¥½ï¼Œä½†çœŸç”¨æˆ·ç½‘ç»œç¯å¢ƒä¸‹åè€Œæ²¡æå‡â€çš„æƒ…å†µã€‚</li>
</ul>
</li>
</ol>


<hr />

<h2>äºŒã€å¸¸ç”¨å·¥å…·æ¨è</h2>

<ol>
<li><p><strong>æµè§ˆå™¨çº§å·¥å…·</strong></p>

<ul>
<li><strong>Chrome DevTools</strong>ï¼šè‡ªå¸¦ Networkã€Performanceã€Coverageã€Lighthouseã€Web Vitalsã€Auditsã€Memory ç­‰é¢æ¿ï¼Œé€‚åˆæœ¬åœ°å¿«é€Ÿå®šä½ç“¶é¢ˆã€‚</li>
</ul>
</li>
<li><p><strong>è‡ªåŠ¨åŒ–æµ‹è¯•ä¸æŠ¥å‘Š</strong></p>

<ul>
<li><strong>Lighthouse CLI / Lighthouse CI</strong>ï¼šæ—¢å¯ä»¥åœ¨æœ¬åœ°å‘½ä»¤è¡Œæ‰§è¡Œ Lighthouse å®¡è®¡ï¼Œä¹Ÿå¯ä»¥é›†æˆåˆ°æŒç»­é›†æˆæµæ°´çº¿é‡Œï¼Œå¯¹æ¯”æ€§èƒ½å¾—åˆ†ã€æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šã€‚</li>
<li><strong>WebPageTest</strong>ï¼šæ”¯æŒå¤šåœ°èŠ‚ç‚¹ã€å¤šç§ç½‘ç»œæ¨¡æ‹Ÿï¼ˆ3Gã€DSLã€å¿«ç½‘ï¼‰ï¼Œå¯ä»¥ç”Ÿæˆç€‘å¸ƒæµï¼ˆWaterfallï¼‰ã€Video Captureã€Filmstripã€Speed Index ç­‰æ•°æ®ã€‚</li>
<li><strong>PageSpeed Insights</strong>ï¼šGoogle å®˜æ–¹å·¥å…·ï¼Œç»“åˆ Lighthouse åˆ†æï¼ŒåŒæ—¶ç»™å‡ºç§»åŠ¨ç«¯ä¸æ¡Œé¢ç«¯çš„è¯„åˆ†ä¸ä¼˜åŒ–å»ºè®®ã€‚</li>
</ul>
</li>
<li><p><strong>çœŸå®ç”¨æˆ·ç›‘æ§ï¼ˆRUMï¼‰</strong></p>

<ul>
<li><strong>Google Analytics</strong>ï¼šå¯ä»¥æ‰“å¼€ Site Speed æŠ¥è¡¨ï¼ŒæŸ¥çœ‹çœŸå®ç”¨æˆ·çš„åŠ è½½æ—¶é—´åˆ†å¸ƒï¼›ä¹Ÿå¯æ¥å…¥è‡ªå®šä¹‰åŸ‹ç‚¹ä¸ŠæŠ¥ FCPã€LCP ç­‰ Web Vitalsã€‚</li>
<li><strong>New Relic Browser / Datadog Browser RUM / Sentry Performance</strong>ï¼šèƒ½å¤Ÿåœ¨ç”Ÿäº§ç¯å¢ƒç›‘æ§ç”¨æˆ·ä½“éªŒï¼Œåˆ†æä¸åŒåœ°åŸŸã€è®¾å¤‡ã€ç½‘ç»œä¸‹çš„æ€§èƒ½è¡¨ç°ã€‚</li>
</ul>
</li>
<li><p><strong>æ‰“åŒ…åˆ†æ</strong></p>

<ul>
<li><strong>Webpack Bundle Analyzer / Source-map-explorer / Rollup-plugin-visualizer</strong>ï¼šå¯è§†åŒ–æ‰“åŒ…ä½“ç§¯ï¼Œæ‰¾å‡ºå“ªä¸ªæ¨¡å—ä½“ç§¯æœ€å¤§ï¼Œè¿›ä¸€æ­¥åšæŒ‰éœ€åŠ è½½æˆ–åˆ é™¤ä¸å¿…è¦ä¾èµ–ã€‚</li>
<li><strong>Bundlephobia</strong>ï¼šåœ¨çº¿æŸ¥çœ‹æŸä¸ª npm åŒ…çš„ä½“ç§¯ã€ä¸‹è½½ç»Ÿè®¡ã€Tree Shaking åä½“ç§¯ç­‰ã€‚</li>
</ul>
</li>
<li><p><strong>å…¶ä»–è¾…åŠ©å·¥å…·</strong></p>

<ul>
<li><strong>Pingdom</strong>ã€<strong>GTmetrix</strong>ï¼šåœ¨çº¿æ€§èƒ½æ£€æµ‹ä¸æŠ¥å‘Šï¼Œç›¸å¯¹ WebPageTest ä¸¥è°¨åº¦ç¨ä½ï¼Œä½†ä¸Šæ‰‹æ›´å¿«ã€‚</li>
<li><strong>BrowserMob Proxy / Fiddler / Charles</strong>ï¼šæŠ“åŒ…å·¥å…·ï¼Œç”¨äºè°ƒè¯• HTTP/HTTPS è¯·æ±‚ï¼ŒæŸ¥çœ‹è¯·æ±‚å¤´ã€å“åº”å¤´ã€Cookieã€é‡å®šå‘é“¾è·¯ã€‚</li>
<li><strong>HEAP Profiler / CPU Profilerï¼ˆChrome DevToolsï¼‰</strong>ï¼šç”¨äºæ·±åº¦åˆ†æ JS è¿è¡Œæ—¶æ€§èƒ½ã€å†…å­˜æ³„æ¼ã€è°ƒç”¨æ ˆç­‰ã€‚</li>
</ul>
</li>
</ol>


<hr />

<h2>ä¸‰ã€Chrome DevTools ä¸­å‡ ä¸ªå¥½ç”¨çš„åŠŸèƒ½</h2>

<p>ä¸‹é¢ç€é‡ä»‹ç»å‡ ä¸ªåœ¨å®é™…æ’æŸ¥ç½‘ç»œä¸æ¸²æŸ“æ€§èƒ½æ—¶ç»å¸¸ä¼šç”¨åˆ°çš„é¢æ¿ä¸è¦ç‚¹ã€‚</p>

<h3>1. Network é¢æ¿ï¼ˆç½‘ç»œé¢æ¿ï¼‰</h3>

<ul>
<li><p><strong>Waterfall ç€‘å¸ƒæµ</strong></p>

<ul>
<li>æ¯ä¸ªèµ„æºçš„è¯·æ±‚æ—¶åºï¼šDNS æŸ¥è¯¢ã€TCP å»ºç«‹ã€SSL æ¡æ‰‹ã€è¯·æ±‚å‘é€ï¼ˆRequest Sentï¼‰ã€ç­‰å¾…æœåŠ¡å™¨å“åº”ï¼ˆWaiting / TTFBï¼‰ã€å†…å®¹ä¸‹è½½ï¼ˆContent Downloadï¼‰ã€ä»¥åŠç»“æŸæ—¶é—´ã€‚</li>
<li>ä»ç€‘å¸ƒæµä¸Šå¯ä»¥ç›´è§‚çœ‹å‡ºæ˜¯å¦æœ‰â€œé˜Ÿå¤´é˜»å¡â€ï¼ˆHead-of-line Blockingï¼‰ã€å“ªä¸ªè¯·æ±‚æ˜¯é˜»å¡æ¸²æŸ“çš„å…³é”®è¯·æ±‚ã€‚</li>
</ul>
</li>
<li><p><strong>æŒ‰åŸŸåä¸èµ„æºç±»å‹åˆ†ç»„</strong></p>

<ul>
<li>åœ¨ Headers æ ç›®é‡Œå¯æŸ¥çœ‹æ‰€æœ‰è¯·æ±‚çš„åŸŸåã€è¯·æ±‚æ–¹æ³•ï¼ˆGET/POSTï¼‰ã€çŠ¶æ€ç ã€å†…å®¹å¤§å°ç­‰ï¼›</li>
<li>åœ¨ Sizes æ ç›®é‡Œå¯å¿«é€Ÿçœ‹å“ªä¸ªèµ„æºå ç”¨æµé‡æœ€å¤šï¼›</li>
<li>åœ¨ Initiator æ ç›®å¯ä»¥çœ‹åˆ°æ˜¯å“ªä¸ªè„šæœ¬æˆ–å“ªä¸ª HTML æ ‡ç­¾å‘èµ·çš„è¯·æ±‚ã€‚</li>
</ul>
</li>
<li><p><strong>è¿‡æ»¤å’Œç­›é€‰</strong></p>

<ul>
<li>å¯ä»¥é€šè¿‡â€œJS/CSS/Img/Media/Font/Doc/XHRâ€ç­‰æ ‡ç­¾å¿«é€Ÿè¿‡æ»¤ï¼›</li>
<li>ä¹Ÿå¯ä»¥åœ¨ Filter è¾“å…¥æ¡†é‡Œæ ¹æ® URL å…³é”®å­—æˆ–æ­£åˆ™ç­›é€‰æ„Ÿå…´è¶£çš„è¯·æ±‚ï¼›</li>
</ul>
</li>
<li><p><strong>Disable Cacheï¼ˆç¦ç”¨ç¼“å­˜ï¼‰</strong></p>

<ul>
<li>åœ¨å¼€å‘æµ‹è¯•æ—¶å‹¾é€‰â€œDisable cacheâ€å¯ä»¥ç¡®ä¿æ‰€æœ‰è¯·æ±‚éƒ½èµ°ç½‘ç»œè€Œéæœ¬åœ°ç¼“å­˜ï¼Œæ–¹ä¾¿å¤ç°é¦–æ¬¡åŠ è½½æ—¶çš„ç½‘ç»œå¼€é”€ã€‚</li>
</ul>
</li>
<li><p><strong>Throttlingï¼ˆæ¨¡æ‹Ÿç½‘ç»œç¯å¢ƒï¼‰</strong></p>

<ul>
<li>å¯åœ¨ â€œNo throttlingâ€ ä¸‹æ‹‰é‡Œé€‰æ‹©â€œFast 3Gã€Slow 3Gã€Offlineâ€ ç­‰ï¼Œä»¥æ¨¡æ‹Ÿç§»åŠ¨ç½‘ç»œç¯å¢ƒä¸‹çš„åŠ è½½é€Ÿåº¦ã€‚</li>
</ul>
</li>
<li><p><strong>Capture Screenshots</strong></p>

<ul>
<li>å‹¾é€‰å·¦ä¸Šè§’çš„ç›¸æœºå›¾æ ‡åï¼Œåœ¨åŠ è½½è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨æˆªå–é¡µé¢æ¸²æŸ“å¿«ç…§ï¼›é…åˆ Performance é¢æ¿çš„ Filmstrip è§†å›¾ï¼Œå¯ä»¥å®šä½å“ªä¸ªèµ„æºåŠ è½½å®Œæˆå¯¹åº”çš„è§†è§‰å˜åŒ–ã€‚</li>
</ul>
</li>
</ul>


<h3>2. Performance é¢æ¿ï¼ˆæ€§èƒ½é¢æ¿ï¼Œåˆå« Timelineï¼‰</h3>

<ul>
<li><p><strong>å½•åˆ¶æ•´ä¸ªé¡µé¢åŠ è½½ä¸äº¤äº’è¿‡ç¨‹</strong></p>

<ul>
<li>ç‚¹å‡»â€œRecordâ€ï¼ˆå½•åˆ¶ï¼‰ï¼Œç„¶ååˆ·æ–°é¡µé¢æˆ–æ‰§è¡ŒæŸä¸ªæ“ä½œï¼Œå·¥å…·ä¼šæ•è·åŠ è½½æœŸé—´çš„ç½‘ç»œè¯·æ±‚ã€è„šæœ¬æ‰§è¡Œã€å¸ƒå±€ï¼ˆLayoutï¼‰ã€ç»˜åˆ¶ï¼ˆPaintï¼‰ã€åˆæˆï¼ˆCompositeï¼‰ã€åƒåœ¾å›æ”¶ï¼ˆGCï¼‰ç­‰å„é˜¶æ®µè€—æ—¶ã€‚</li>
</ul>
</li>
<li><p><strong>å…³é”®æ—¶é—´çº¿ï¼ˆTimingsï¼‰</strong></p>

<ul>
<li>Top-down è§†å›¾é‡Œä¼šæ ‡æ³¨ CIFï¼ˆDOMContentLoadedï¼‰ã€Loadã€First Paintã€First Contentful Paintã€Largest Contentful Paintã€Time to Interactive ç­‰æ—¶é—´ç‚¹ï¼ˆæœ‰æ—¶éœ€è¦å¼€å¯ Web Vitals æ”¯æŒï¼‰ã€‚</li>
</ul>
</li>
<li><p><strong>æŸ¥çœ‹é•¿ä»»åŠ¡ï¼ˆLong Tasksï¼‰</strong></p>

<ul>
<li>åœ¨ Flame Chart ä¸Šå¯ä»¥çœ‹åˆ°å“ªäº› JavaScript æ‰§è¡Œå ç”¨äº†ä¸»çº¿ç¨‹è¶…è¿‡ 50msï¼Œä¼šè¢«æ ‡æ³¨ä¸ºé•¿ä»»åŠ¡ï¼›æ ¹æ® Call Treeï¼ˆè°ƒç”¨æ ‘ï¼‰å¯ä»¥è¿½æº¯æ˜¯å“ªæ®µä»£ç å¯¼è‡´çš„ã€‚</li>
</ul>
</li>
<li><p><strong>å¸§ç‡ä¸äº¤äº’æµç•…åº¦</strong></p>

<ul>
<li>é€šè¿‡ FPSï¼ˆFrames Per Secondï¼‰è§†å›¾ç›‘æµ‹æ¸²æŸ“å¸§ç‡ï¼Œå¸§ç‡è¿‡ä½å¯èƒ½æ˜¯ç”±äºè¿‡å¤šé‡ç»˜é‡æ’ï¼ˆReflow/Repaintï¼‰æˆ–é¢‘ç¹æ‰§è¡Œ JS é€ æˆã€‚</li>
</ul>
</li>
<li><p><strong>CPU / Memory èŠ‚ç‚¹</strong></p>

<ul>
<li>å¯ä»¥åœ¨å½•åˆ¶æ—¶åˆ†åˆ«æ‰“å¼€ CPU Profiler æˆ– Memory Profilerï¼Œå®šä½å†…å­˜æ³„éœ²æˆ–é«˜ CPU å ç”¨çš„è°ƒç”¨æ ˆã€‚</li>
</ul>
</li>
</ul>


<h3>3. Lighthouse é¢æ¿ï¼ˆå®¡è®¡ï¼‰</h3>

<ul>
<li><p><strong>ä¸€é”®è·‘æ€§èƒ½å®¡è®¡</strong></p>

<ul>
<li>åœ¨ DevTools çš„å³ä¾§æˆ–èœå•ä¸­åˆ‡æ¢åˆ°â€œLighthouseâ€é¢æ¿ï¼Œé€‰æ‹©â€œMobileâ€æˆ–â€œDesktopâ€ï¼Œç„¶åç‚¹å‡»â€œGenerate reportâ€ï¼ˆç”ŸæˆæŠ¥å‘Šï¼‰ã€‚</li>
<li>å®¡è®¡ä¼šæ ¹æ®æœ€æ–°çš„ Lighthouse è§„åˆ™ç»™å‡ºæ€§èƒ½åˆ†æ•°ï¼ˆ0â€“100ï¼‰ï¼Œå¹¶åˆ—å‡ºå¯ä¼˜åŒ–é¡¹ï¼ˆä¾‹å¦‚ï¼šå‡å°‘é¦–æ¬¡å†…å®¹ç»˜åˆ¶æ—¶é—´ã€å¯ç”¨æ–‡æœ¬å‹ç¼©ã€å›¾ç‰‡å…ƒç´ æ‰€å ç©ºé—´å»ºè®®ã€ä½¿ç”¨åˆå¹¶è„šæœ¬ç­‰ï¼‰ã€‚</li>
</ul>
</li>
<li><p><strong>å¯è§†åŒ–å»ºè®®ä¸è¯¦æƒ…</strong></p>

<ul>
<li>å¯¹æ¯ä¸€é¡¹å¾—åˆ†ï¼ŒLighthouse éƒ½ä¼šç»™å‡ºâ€œä¸ºä»€ä¹ˆé‡è¦â€ã€â€œå¦‚ä½•ä¼˜åŒ–â€çš„è¯¦ç»†è¯´æ˜ï¼Œä»¥åŠä¸åŒè¡Œä¸šç½‘ç«™çš„å¯¹æ¯”ã€‚éå¸¸é€‚åˆåšä¸€æ¬¡æ€§å¥åº·æ£€æŸ¥ã€‚</li>
</ul>
</li>
</ul>


<h3>4. Coverage é¢æ¿ï¼ˆè¦†ç›–ç‡æ£€æµ‹ï¼‰</h3>

<ul>
<li><p><strong>Detect Unused CSS/JSï¼ˆæ£€æµ‹æœªä½¿ç”¨ä»£ç ï¼‰</strong></p>

<ul>
<li>æ‰“å¼€ DevTools åï¼ŒæŒ‰ <code>Ctrl+Shift+P</code>ï¼ˆWindowsï¼‰æˆ– <code>âŒ˜+Shift+P</code>ï¼ˆMacï¼‰ï¼Œè¾“å…¥ â€œCoverage: Show Coverageâ€ å¹¶å›è½¦ï¼Œæ‰“å¼€ Coverage é¢æ¿ã€‚</li>
<li>ç‚¹å‡»å·¦ä¸Šè§’å°åœ†ç‚¹å¼€å§‹å½•åˆ¶ï¼Œå†æ¬¡åˆ·æ–°é¡µé¢ã€‚å·¥å…·ä¼šæ‰«æé¡µé¢åŠ è½½è¿‡ç¨‹ä¸­å“ªäº› CSS/JS ä»£ç å—è¢«å®é™…ä½¿ç”¨ã€å“ªäº›æœªç”¨ã€‚</li>
<li>æ ¹æ®æœªä½¿ç”¨ç™¾åˆ†æ¯”ï¼Œå¯ä»¥è€ƒè™‘ç§»é™¤æˆ–æ‹†åˆ†é‚£äº›å†—ä½™å¾ˆé«˜çš„æ¨¡å—ã€‚</li>
</ul>
</li>
</ul>


<h3>5. Web Vitals / Core Web Vitals</h3>

<ul>
<li><p><strong>å®æ—¶æŸ¥çœ‹ LCPã€FIDã€CLS</strong></p>

<ul>
<li>åœ¨æœ€æ–°ç‰ˆæœ¬çš„ Chrome DevTools çš„ Performance é¢æ¿ä¸­ï¼Œå¦‚æœå‹¾é€‰äº† â€œCapture Web Vitalsâ€ï¼Œå½•åˆ¶æ—¶å°±ä¼šåœ¨æ—¶é—´è½´ä¸Šæ ‡æ³¨ LCPã€FIDã€CLS ç­‰å…³é”®æŒ‡æ ‡ã€‚</li>
<li>ä¹Ÿå¯ä»¥é€šè¿‡æ§åˆ¶å°å‘½ä»¤ <code>performance.getEntriesByType('paint')</code> æŸ¥çœ‹ First Paint (FP) ä¸ First Contentful Paint (FCP) æ—¶é—´ã€‚</li>
</ul>
</li>
</ul>


<h3>6. Audit for Networking/Blocking</h3>

<ul>
<li><p><strong>Disable JavaScript / CSS</strong></p>

<ul>
<li>åœ¨ Network é¢æ¿ä¸­å³é”®æŸä¸ªè„šæœ¬æˆ–æ ·å¼æ–‡ä»¶ï¼Œé€‰æ‹© â€œBlock request URLâ€ï¼Œå³å¯ä¸´æ—¶å±è”½è¯¥èµ„æºï¼Œç„¶åè§‚å¯Ÿé¡µé¢è¡¨ç°ï¼Œä¾¿äºåœ¨æ— éœ€æ”¹ä»£ç çš„æƒ…å†µä¸‹åˆ¤æ–­æŸä¸ªåº“/æ ·å¼å¯¹é¦–å±æ¸²æŸ“çš„é˜»å¡ç¨‹åº¦ã€‚</li>
</ul>
</li>
<li><p><strong>Request Blocking</strong></p>

<ul>
<li>DevTools çš„ â€œNetworkâ€ é¢æ¿ä¸­æœ‰ä¸€ä¸ª â€œBlockâ€ é€‰é¡¹å¡ï¼Œå¯ä»¥è‡ªå®šä¹‰åŒ¹é…è§„åˆ™ï¼ˆå¦‚æ­£åˆ™ï¼‰å±è”½ç‰¹å®šåŸŸåã€æ–‡ä»¶ç±»å‹çš„è¯·æ±‚ï¼Œæµ‹è¯•è‹¥è¯¥è¯·æ±‚ä¸åŠ è½½ï¼Œå¯¹é¡µé¢åŠ è½½æœ‰ä½•å½±å“ã€‚</li>
</ul>
</li>
</ul>


<h3>7. å…¶ä»–è¾…åŠ©åŠŸèƒ½</h3>

<ul>
<li><p><strong>Inspect Mode ä¸ Layout Shift Region</strong></p>

<ul>
<li>åœ¨ Elements é¢æ¿ä¸­ï¼Œå³ä¸Šè§’æœ‰ä¸€ä¸ª â€œInspect elementâ€ æŒ‰é’®ï¼Œå¯ä»¥ç›´æ¥é€‰ä¸­é¡µé¢å…ƒç´ ï¼Œåœ¨å³ä¾§çœ‹åˆ°å¯¹åº”çš„ CSS è§„åˆ™ã€ç›’æ¨¡å‹ï¼ˆBox Modelï¼‰ä¿¡æ¯ã€ç»§æ‰¿é“¾ç­‰ï¼Œä¾¿äºä¼˜åŒ–æ ·å¼ã€‚</li>
</ul>
</li>
<li><p><strong>Performance Monitor</strong></p>

<ul>
<li>åœ¨ DevTools èœå•é‡Œå‹¾é€‰ â€œPerformance Monitorâ€ï¼Œå¯åœ¨é¡¶éƒ¨æ˜¾ç¤º CPU åˆ©ç”¨ç‡ã€DOM Nodes æ•°é‡ã€JS Heapã€Layout é˜Ÿåˆ—é•¿åº¦ç­‰å®æ—¶æ•°æ®ï¼Œå¯¹å‘ç°æ€§èƒ½ç“¶é¢ˆæœ‰è¾…åŠ©æ„ä¹‰ã€‚</li>
</ul>
</li>
<li><p><strong>Application é¢æ¿</strong></p>

<ul>
<li>æŸ¥çœ‹ Cache Storageã€Service Workerã€Local Storageã€IndexedDBã€Cookie ç­‰ã€‚è‹¥é¡¹ç›®å¯ç”¨äº† PWAï¼Œå¯ä»¥æŸ¥çœ‹ç¦»çº¿ç¼“å­˜ç­–ç•¥æ˜¯å¦ç”Ÿæ•ˆã€Service Worker æ˜¯å¦å‡ºç°å¼‚å¸¸ã€‚</li>
</ul>
</li>
</ul>


<hr />

<h2>å››ã€å°ç»“</h2>

<ul>
<li><strong>æŠ“å¤§æ”¾å°ï¼Œæœ‰çš„æ”¾çŸ¢</strong>ï¼šé¦–å…ˆè¦é‡åŒ–å‡ ä¸ªå…³é”®æ€§èƒ½æŒ‡æ ‡ï¼ˆå¦‚ FCPã€LCPã€TTIï¼‰ï¼Œæ˜ç¡®â€œå“ªé‡Œå¡â€ï¼Œåˆ†æâ€œä¸ºä»€ä¹ˆå¡â€ï¼›</li>
<li><strong>æ•°æ®é©±åŠ¨ä¼˜åŒ–</strong>ï¼šå€ŸåŠ© Lighthouseã€Chrome DevToolsã€WebPageTest ç­‰å·¥å…·å½¢æˆåˆå§‹æŠ¥å‘Šï¼Œä»ç½‘ç»œã€èµ„æºã€æ¸²æŸ“ã€è„šæœ¬æ‰§è¡Œç­‰è§’åº¦åˆ†åˆ«å‰–æï¼›</li>
<li><strong>ç»†åŒ–æ‰‹æ®µ</strong>ï¼šä»å‡å°‘è¯·æ±‚æ•°ã€å‡å°è¯·æ±‚ä½“ç§¯ã€åˆç†ç¼“å­˜ç­–ç•¥ã€å¼‚æ­¥åŠ è½½ã€æ‡’åŠ è½½ã€æ‹†åŒ…é™ç»´ã€ä¼˜åŒ–æ¸²æŸ“è·¯å¾„ç­‰å¤šæ–¹é¢å…¥æ‰‹ï¼›</li>
<li><strong>è¿­ä»£ä¸ç›‘æ§</strong>ï¼šæ¯ä¸€æ¬¡ä¼˜åŒ–éƒ½è¦éªŒè¯æŒ‡æ ‡å˜åŒ–ï¼Œå¹¶ç»“åˆ RUM ç›‘æ§çœŸå®ç”¨æˆ·ä½“éªŒï¼Œé¿å… â€œåˆæˆæŒ‡æ ‡â€ ä¸ â€œçœŸå®æŒ‡æ ‡â€ è„±èŠ‚ã€‚</li>
</ul>


<p>æŒæ¡å¹¶çµæ´»è¿ç”¨ä»¥ä¸Šæ€è·¯å’Œå·¥å…·ï¼Œç›¸ä¿¡ä½ åœ¨åˆ†æå’Œä¼˜åŒ– Web åº”ç”¨èµ„æºåŠ è½½æ€§èƒ½æ—¶ï¼Œä¼šæ›´åŠ é«˜æ•ˆã€æœ‰çš„æ”¾çŸ¢ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Babelå·¥ä½œåŸç†]]></title>
    <link href="http://hongchaozhang.github.io/blog/2025/03/24/babel-workflow/"/>
    <updated>2025-03-24T23:20:31+08:00</updated>
    <id>http://hongchaozhang.github.io/blog/2025/03/24/babel-workflow</id>
    <content type="html"><![CDATA[<!-- more -->


<p>Babel is a JavaScript compilerã€‚
ä¸»è¦ç”¨äºå°† ECMAScript 2015+ï¼ˆES6 åŠä»¥ä¸Šï¼‰çš„ JavaScript ä»£ç è½¬æ¢æˆèƒ½å¤Ÿåœ¨å½“å‰å’Œæ—§ç‰ˆæµè§ˆå™¨ç¯å¢ƒä¸­å…¼å®¹è¿è¡Œçš„ä»£ç ç‰ˆæœ¬ã€‚</p>

<h1>é…ç½®</h1>

<p>Babel çš„é…ç½®æ–‡ä»¶é€šå¸¸æ˜¯<code>.babelrc.json</code>æˆ–<code>babel.config.json</code>ï¼Œå¯ä»¥åœ¨å…¶ä¸­é…ç½®éœ€è¦ä½¿ç”¨çš„æ’ä»¶å’Œé¢„è®¾:</p>

<pre><code>{
  "presets": [...],
  "plugins": [...]
}
</code></pre>

<p>ç”šè‡³å¯ä»¥ç›´æ¥å†™åœ¨<code>package.json</code>ä¸­ï¼š</p>

<pre><code>{
  ...,
  "babel": {
    "presets": [...],
    "plugins": [...]
  },
  ...
}
</code></pre>

<p>æ›´åŠ çµæ´»çš„ï¼Œå¯ä»¥åœ¨<code>webpack.config.js</code>ä¸­è®¿é—® Node.js çš„ APIsï¼š</p>

<pre><code>module.exports = function (api) {
  api.cache(true);

  const presets = [ ... ];
  const plugins = [ ... ];

  if (process.env["ENV"] === "prod") {
    plugins.push(...);
  }

  return {
    presets,
    plugins
  };
}
</code></pre>

<h1>å·¥ä½œæµç¨‹</h1>

<p><img src="/images/babel-workflow.png" alt="babel workflow" /></p>

<p>Babel çš„ç¼–è¯‘è¿‡ç¨‹ä¸å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘å™¨ç±»ä¼¼ï¼Œåˆ†ä¸ºä¸‰ä¸ªä¸»è¦é˜¶æ®µï¼šè§£æï¼ˆParsingï¼‰ã€è½¬æ¢ï¼ˆTransformationï¼‰å’Œç”Ÿæˆï¼ˆCode Generationï¼‰</p>

<h2>è§£æï¼ˆParsingï¼‰</h2>

<p>è¿™ä¸€é˜¶æ®µå°†ä»£ç å­—ç¬¦ä¸²è§£ææˆæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼ŒAbstract Syntax Treeï¼‰<a href="https://developer.aliyun.com/article/1303957">2</a><a href="https://blog.csdn.net/ByteDanceTech/article/details/126900235">3</a>ã€‚AST æ˜¯æºä»£ç çš„æŠ½è±¡è¯­æ³•ç»“æ„çš„æ ‘çŠ¶è¡¨ç¤ºï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„<a href="https://developer.aliyun.com/article/1303957">2</a>ã€‚
è§£æè¿‡ç¨‹åˆåˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š</p>

<ul>
<li>åˆ†è¯ï¼šå°†æ•´ä¸ªä»£ç å­—ç¬¦ä¸²åˆ†å‰²æˆè¯­æ³•å•å…ƒæ•°ç»„ï¼štokenizerï¼Œkeyword</li>
<li>è¯­æ³•åˆ†æï¼šå»ºç«‹åˆ†æè¯­æ³•å•å…ƒä¹‹é—´çš„å…³ç³»<a href="https://developer.aliyun.com/article/1303957">2</a></li>
</ul>


<p>ä¾‹å¦‚ï¼Œä¸€ä¸ªç®€å•çš„<code>console.log('zcy');</code>ä¼šè¢«è§£ææˆåŒ…å«ç¨‹åºç»“æ„ã€è¡¨è¾¾å¼è¯­å¥ã€è°ƒç”¨è¡¨è¾¾å¼ç­‰èŠ‚ç‚¹çš„ AST<a href="https://developer.aliyun.com/article/1303957">2</a>ã€‚</p>

<pre><code>{
  "type": "Program",
  "body": [
    {
      "type": "ExpressionStatement",
      "expression": {
        "type": "CallExpression",
        "callee": {
          "type": "MemberExpression",
          "computed": false,
          "object": {
            "type": "Identifier",
            "name": "console"
          },
          "property": {
            "type": "Identifier",
            "name": "log"
          }
        },
        "arguments": [
          {
          "type": "Literal",
          "value": "zcy",
          "raw": "'zcy'"
          }
        ]
      }
    }
  ],
  "sourceType": "script"
}
</code></pre>

<h2>è½¬æ¢ï¼ˆTransformationï¼‰</h2>

<p>è¿™ä¸€é˜¶æ®µå¯¹ AST è¿›è¡Œè½¬æ¢æ“ä½œ<a href="https://developer.aliyun.com/article/1303957">2</a><a href="https://blog.csdn.net/ByteDanceTech/article/details/126900235">3</a>ã€‚è½¬æ¢é€šå¸¸é€šè¿‡ Babel pluginï¼ˆæ’ä»¶ï¼‰æˆ–è€… presetï¼ˆé¢„è®¾ï¼‰å®ç°ï¼Œæ¯ä¸ªæ’ä»¶å¯ä»¥è®¿é—® AST å¹¶å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œä¾‹å¦‚å°†ç®­å¤´å‡½æ•°çš„èŠ‚ç‚¹è½¬æ¢ä¸ºæ™®é€šå‡½æ•°èŠ‚ç‚¹ã€‚</p>

<h3>pluginï¼ˆæ’ä»¶ï¼‰</h3>

<p>Babel æœ¬èº«åªæ˜¯ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ¡†æ¶ï¼Œå°±åƒä¸€ä¸ªçº¯å‡½æ•°<code>const babel = code =&gt; code</code>ä¸€æ ·ï¼Œåªè´Ÿè´£è§£æç„¶åç”Ÿæˆä»£ç ã€‚è¦å®ç°å…·ä½“çš„è½¬æ¢åŠŸèƒ½ï¼Œéœ€è¦æ·»åŠ å’Œä½¿ç”¨æ’ä»¶ï¼ˆpluginsï¼‰ã€‚
ä¾‹å¦‚ï¼Œè¦å°†ç®­å¤´å‡½æ•°è½¬æ¢ä¸ºæ™®é€šå‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨å®˜æ–¹æä¾›çš„<code>@babel/plugin-transform-arrow-functions</code>æ’ä»¶<a href="https://www.xuwenchao.site/blogs/babel.html">1</a>ã€‚æ¯ä¸ªæ’ä»¶è´Ÿè´£ç‰¹å®šç±»å‹çš„è¯­æ³•è½¬æ¢ï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ ç›¸åº”çš„æ’ä»¶ã€‚</p>

<h3>presetsï¼ˆé¢„è®¾ï¼‰</h3>

<p>å¦‚æœè¦ç¼–è¯‘ä¸€ä¸ªå®Œæ•´çš„åº”ç”¨ï¼Œå•ç‹¬é…ç½®æ¯ä¸ªæ‰€éœ€çš„æ’ä»¶ä¼šéå¸¸ç¹çã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒBabel å¼•å…¥äº† presetsï¼ˆé¢„è®¾ï¼‰çš„æ¦‚å¿µ<a href="https://www.xuwenchao.site/blogs/babel.html">1</a>ã€‚
presets å¯ä»¥ç†è§£ä¸º plugins å’Œéƒ¨åˆ†é…ç½®çš„é›†åˆï¼Œä½¿ç”¨é¢„è®¾å¯ä»¥é¿å…å•ç‹¬é…ç½®æ¯ä¸ª plugin å’Œå‚æ•°ï¼Œç›´æ¥ä½¿ç”¨å·²ç»ç»„åˆå¥½çš„é…ç½®å³å¯<a href="https://www.xuwenchao.site/blogs/babel.html">1</a>ã€‚å¸¸è§çš„é¢„è®¾åŒ…æ‹¬<code>@babel/preset-env</code>ã€<code>@babel/preset-react</code>ç­‰ã€‚</p>

<p>@babel/preset-env åŒ…å«ä»¥ä¸‹æ’ä»¶ï¼š</p>

<ul>
<li>@babel/plugin-transform-template-literals</li>
<li>@babel/plugin-transform-literals</li>
<li>@babel/plugin-transform-function-name</li>
<li>@babel/plugin-transform-arrow-functions</li>
<li>@babel/plugin-transform-block-scoped-functions</li>
<li>@babel/plugin-transform-classes</li>
<li>@babel/plugin-transform-object-super</li>
</ul>


<p>@babel/preset-react åŒ…å«ä»¥ä¸‹æ’ä»¶ï¼š</p>

<ul>
<li>@babel/plugin-syntax-jsx</li>
<li>@babel/plugin-transform-react-jsx</li>
<li>@babel/plugin-transform-react-display-name</li>
</ul>


<h2>ç”Ÿæˆï¼ˆCode Generationï¼‰</h2>

<p>æœ€åä¸€ä¸ªé˜¶æ®µæ˜¯æ ¹æ®è½¬æ¢åçš„ AST ç”Ÿæˆæ–°çš„ä»£ç å­—ç¬¦ä¸²ã€‚è¿™ä¸€è¿‡ç¨‹åŒ…æ‹¬å°† AST ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æ˜ å°„å›å­—ç¬¦ä¸²å½¢å¼ï¼Œå¹¶ç”Ÿæˆæºç æ˜ å°„ï¼ˆsource mapsï¼‰ã€‚</p>

<h1>ç»“è®º</h1>

<p>Babel ä½œä¸ºç°ä»£å‰ç«¯å¼€å‘çš„é‡è¦å·¥å…·ï¼Œä¸ºå¼€å‘è€…æä¾›äº†ä½¿ç”¨æœ€æ–° JavaScript ç‰¹æ€§çš„èƒ½åŠ›ï¼ŒåŒæ—¶ä¿è¯äº†ä»£ç åœ¨å„ç§æµè§ˆå™¨ç¯å¢ƒä¸­çš„å…¼å®¹æ€§ã€‚æ·±å…¥ç†è§£ Babel çš„åŸºæœ¬æ¦‚å¿µã€å·¥ä½œæµç¨‹å’Œä½¿ç”¨æ–¹æ³•ï¼Œå¯¹äºå‰ç«¯å¼€å‘è€…æå‡å¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡æœ‰ç€é‡è¦æ„ä¹‰ã€‚</p>

<p>ä»å…¥é—¨çš„åŸºæœ¬ä½¿ç”¨ï¼Œåˆ°è¿›é˜¶çš„æ’ä»¶å¼€å‘ï¼Œå†åˆ°ä¸“ä¸šçš„æ€§èƒ½ä¼˜åŒ–ï¼ŒBabel çš„å­¦ä¹ æ˜¯ä¸€ä¸ªå¾ªåºæ¸è¿›çš„è¿‡ç¨‹ã€‚éšç€å¯¹ Babel çš„ä¸æ–­æ·±å…¥å­¦ä¹ å’Œå®è·µï¼Œå¼€å‘è€…èƒ½å¤Ÿæ›´åŠ çµæ´»åœ°åˆ©ç”¨è¿™ä¸€å·¥å…·ï¼Œæ„å»ºæ›´åŠ ç°ä»£åŒ–ã€é«˜æ•ˆçš„å‰ç«¯åº”ç”¨ã€‚</p>

<h1>åº”ç”¨åœºæ™¯</h1>

<ul>
<li>ç¼–è¾‘å™¨</li>
<li>LSP language server protocol</li>
<li>è¯­æ³•é«˜äº®ï¼Œè‡ªåŠ¨è¡¥å…¨</li>
<li>é™æ€ä»£ç åˆ†æ</li>
<li>ä»£ç è½¬æ¢</li>
<li>ä»£ç å‹ç¼©å’Œä¼˜åŒ–</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CSS resolution rules and specificity]]></title>
    <link href="http://hongchaozhang.github.io/blog/2024/06/17/css-resolution-rules-and-specificity/"/>
    <updated>2024-06-17T11:53:39+08:00</updated>
    <id>http://hongchaozhang.github.io/blog/2024/06/17/css-resolution-rules-and-specificity</id>
    <content type="html"><![CDATA[<!-- more -->


<h2>Description</h2>

<p>The css property doesn&rsquo;t take effect in the release build but works fine in the debug build.</p>

<h2>Root cause</h2>

<p>We applied two css classes in one dom node and didnâ€™t specify the priority (have the same css specificity (0,1,0)), thus the CSS class order matters: the latter one will override the previous one.</p>

<p>However, the css class order is not stable between the debug and release builds.</p>

<h2>Solution</h2>

<p>After fixing, the classes are like this:</p>

<p><img src="/images/css-specificity-1.png" alt="css-specificity-1" /></p>

<p>We can use the scss file helper tools in VS Code:</p>

<p><img src="/images/css-specificity-2.png" alt="css-specificity-2" /></p>

<p>Caution while nesting &amp; :</p>

<p><img src="/images/css-specificity-3.png" alt="css-specificity-3" /></p>

<h2><a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/Building_blocks/Cascade_and_inheritance">Cascade</a></h2>

<p>When two rules from the same cascade layer apply and both have equal specificity, the one that is defined last in the stylesheet is the one that will be used.</p>

<p>There are three factors to consider, listed here in increasing order of importance. Later ones overrule earlier ones:</p>

<h3>Source order</h3>

<h3><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Specificity">Specificity</a></h3>

<ul>
<li>one identifier selector has 1-0-0 specificity</li>
<li>one class selector (attribute selector) has 0-1-0 specificity</li>
<li>one element selector has 0-0-1 specificity</li>
<li>The specificity weight of :not/:is/:has comes from the selector parameter in the list of selectors with the highest specificity.</li>
<li>Combinators, such as +, >, ~, &ldquo; &rdquo;, and ||, may make a selector more specific in what is selected but they don&rsquo;t add any value to the specificity weight.</li>
</ul>


<p><img src="/images/css-specificity-4.png" alt="css-specificity-4" /></p>

<h3>Importance</h3>

<ul>
<li>inline style</li>
<li><code>!important</code>: DO NOT use <code>!important</code>. It makes the CSS hard to maintain and debug.

<ul>
<li>See a demo for <code>!important</code> <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/Building_blocks/Cascade_and_inheritance#!important">here</a>.</li>
</ul>
</li>
</ul>


<h2>Other info</h2>

<p>The VS Code should have issues with â€œspecificityâ€ calculation.</p>

<p><img src="/images/css-specificity-5.png" alt="css-specificity-5" /></p>

<p>The specificity should be 0-2-0.</p>

<p>More examples can be seen from here: <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Specificity#three-column_comparison">Specificity</a></p>

<p><img src="/images/css-specificity-6.png" alt="css-specificity-6" /></p>

<p>Some online css specificity calculator can be used for testing:</p>

<p><a href="https://specificity.keegan.st/">Specificity Calculator</a></p>

<h2>How to avoid such issues?</h2>

<ul>
<li>Make sure all the loaded CSSs have different css specificity.</li>
<li>Review the CSS in the developer tool.</li>
<li>For a specific css property, filter out all CSSs which contains it.</li>
<li>Make sure the CSS you want to apply have the highest css specificity.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[React Learning Note 2023]]></title>
    <link href="http://hongchaozhang.github.io/blog/2023/09/15/react-learning-note-2023/"/>
    <updated>2023-09-15T17:33:08+08:00</updated>
    <id>http://hongchaozhang.github.io/blog/2023/09/15/react-learning-note-2023</id>
    <content type="html"><![CDATA[<!-- more -->


<ul>
<li><a href="#react-state-is-updated-in-a-batch">React state is updated in a â€œbatchâ€</a></li>
<li><a href="#update-react-state-with-a-new-object-do-not-mute-existing-one">Update react state with a new object, do not mute existing one</a></li>
<li><a href="#declarative-ui">Declarative UI</a></li>
<li><a href="#react-redux">React-redux</a></li>
<li><a href="#hooks">Hooks</a></li>
<li><a href="#react%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F">Reactä¸­çš„å˜é‡</a></li>
<li><a href="#useeffect">useEffect</a>

<ul>
<li><a href="#clean-up-function">clean up function</a></li>
</ul>
</li>
<li><a href="#usememo">useMemo</a></li>
<li><a href="#two-ways-to-store-previous-props">two ways to store previous props</a>

<ul>
<li><a href="#useref">useRef</a></li>
<li><a href="#usestate">useState</a></li>
</ul>
</li>
<li><a href="#fetch-data%E7%9A%84%E4%B8%A4%E4%B8%AA%E9%97%AE%E9%A2%98">fetch dataçš„ä¸¤ä¸ªé—®é¢˜</a>

<ul>
<li><a href="#race-condition">race condition</a></li>
<li><a href="#undo">undo</a></li>
</ul>
</li>
<li><a href="#effect-event">Effect Event</a>

<ul>
<li><a href="#what-is-reactive">what is reactive</a></li>
<li><a href="#problem">Problem</a></li>
<li><a href="#solution">Solution:</a></li>
<li><a href="#supress-react-lint-error">Supress react lint error</a></li>
</ul>
</li>
<li><a href="#how-to-review-effect-dependencies">How to review effect dependencies</a>

<ul>
<li><a href="#ways-to-review-and-fix-this">ways to review and fix this</a></li>
</ul>
</li>
<li><a href="#object-and-function-compare">Object and function compare</a></li>
<li><a href="#usememo-and-usecallback">useMemo and useCallback</a></li>
<li><a href="#forwardref">forwardRef</a>

<ul>
<li><a href="#useref-1">useRef</a></li>
<li><a href="#basic-concepts">basic concepts</a></li>
<li><a href="#expose-dom-node">expose dom node</a></li>
<li><a href="#expose-an-object">expose an object</a></li>
</ul>
</li>
<li><a href="#custom-hook">Custom Hook</a></li>
<li><a href="#strict-mode">strict mode</a></li>
<li><a href="#other-rules">Other Rules</a>

<ul>
<li><a href="#data-from-parent-to-child">data from parent to child</a></li>
<li><a href="#usesyncexternalstore">useSyncExternalStore</a></li>
<li><a href="#useeffect-dependencies">useEffect dependencies</a></li>
</ul>
</li>
</ul>


<h2>React state is updated in a â€œbatchâ€</h2>

<p>This means that you can not get the state immediately after you change it.</p>

<p>number will be 1 after one click:
<code>
export default function Counter() {
  const [number, setNumber] = useState(0);
  return (
    &lt;&gt;
      &lt;h1&gt;{number}&lt;/h1&gt;
      &lt;button onClick={() =&gt; {
        setNumber(number + 1);
        setNumber(number + 1);
        setNumber(number + 1);
      }}&gt;+3&lt;/button&gt;
    &lt;/&gt;
  )
}
</code>
To make the number to be 3, pass a update function to the setNumber function. An update function will be queued and executed later.
<code>
export default function Counter() {
  const [number, setNumber] = useState(0);
  return (
    &lt;&gt;
      &lt;h1&gt;{number}&lt;/h1&gt;
      &lt;button onClick={() =&gt; {
        setNumber(n =&gt; n + 1);
        setNumber(n =&gt; n + 1);
        setNumber(n =&gt; n + 1);
      }}&gt;+3&lt;/button&gt;
    &lt;/&gt;
  )
}
</code></p>

<h2>Update react state with a new object, do not mute existing one</h2>

<p>Use <code>â€¦</code> , the object spread operator:
<code>
setPerson({
  ...person, // Copy the old fields
  firstName: e.target.value // But override this one
});
</code>
Note that spread syntax is shallow: it only copies one level deep. To update nested object:
<code>
setPerson({
  ...person, // Copy other fields
  artwork: { // but replace the artwork
    ...person.artwork, // with the same one
    city: 'New Delhi' // but in New Delhi!
  }
});
</code>
For updating array object:
<code>
setArtists([
  { id: nextId++, name: name },
  ...artists // Put old items at the end
]);
</code>
<code>Immer</code> is a popular library that lets you write using the convenient but mutating syntax and takes care of producing the copies for you.
<code>
updatePerson(draft =&gt; {
  draft.artwork.city = 'Lagos';
});
</code>
Using <code>Immer</code> for array:
<code>
updateMyTodos(draft =&gt; {
  const artwork = draft.find(a =&gt; a.id === artworkId);
  artwork.seen = nextSeen;
});
</code></p>

<h2>Declarative UI</h2>

<ul>
<li>Declarative programming means describing the UI for each visual state rather than micromanaging the UI (imperative).</li>
<li>When developing a component, Think in declarative UI way:

<ol>
<li>Identify all its visual states.</li>
<li>Determine the human and computer triggers for state changes.</li>
<li>Model the state with useState.</li>
<li>Remove non-essential state to avoid bugs and paradoxes.</li>
<li>Connect the event handlers to set state.</li>
</ol>
</li>
</ul>


<h2>React-redux</h2>

<ul>
<li>useReducer+useContext?</li>
<li>Provider</li>
<li>Context</li>
</ul>


<h2>Hooks</h2>

<ul>
<li>useContext: è·¨å±‚ä¼ è¾“propsï¼Œä¸ç”¨ä¸€å±‚ä¸€å±‚ä¼ ä¸‹å»</li>
<li>useEffect: Use them to synchronize your component with a system outside of React.</li>
</ul>


<h2>Reactä¸­çš„å˜é‡</h2>

<ul>
<li>Propsï¼šimmutable, è§¦å‘rerenderï¼Œä¸è®°å¿†(retained by component)</li>
<li>Stateï¼šimmutable, è§¦å‘rerenderï¼Œè®°å¿†(retained by React)</li>
<li>useRefï¼šmutable, ä¸è§¦å‘rerenderï¼Œè®°å¿†(retained by React)</li>
</ul>


<h2>useEffect</h2>

<p>Effects let you specify side effects that are caused by rendering itself, rather than by a particular event.</p>

<p>Effects run at the end of a <em>commit</em> after the screen updates. That is, useEffect â€œdelaysâ€ a piece of code from running until that render is reflected on the screen.</p>

<h3>clean up function</h3>

<p>You can use a clean up function to clean up the effect. For example, if you subscribe to an external data source, you can unsubscribe it in the clean up function.
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>useEffect(() =&gt; {
</span><span class='line'>  const connection = createConnection();
</span><span class='line'>  connection.connect();
</span><span class='line'>  return () =&gt; {
</span><span class='line'>    connection.disconnect();
</span><span class='line'>  };
</span><span class='line'>}, []);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;useEffect(() =&gt; {
</span><span class='line'>  function handleScroll(e) {
</span><span class='line'>    console.log(window.scrollX, window.scrollY);
</span><span class='line'>  }
</span><span class='line'>  window.addEventListener(&lsquo;scroll&rsquo;, handleScroll);
</span><span class='line'>  return () =&gt; window.removeEventListener(&lsquo;scroll&rsquo;, handleScroll);
</span><span class='line'>}, []);</span></code></pre></td></tr></table></div></figure>
<strong>React will call your cleanup function each time before the next Effect runs again, and one final time when the component unmounts (gets removed).</strong>
That is, the cleanup function runs not only during unmount, but before every re-render with changed dependencies.</p>

<h2>useMemo</h2>

<p>useMemoå’ŒuseEffectéƒ½å¯ä»¥åŠ ä¾èµ–ï¼Œä½†æ˜¯useMemoåœ¨renderè¿‡ç¨‹èµ·ä½œç”¨ï¼Œè€ŒuseEffectåœ¨commitä¹‹åèµ·ä½œç”¨ã€‚
æ‰€ä»¥ï¼Œå¦‚æœæ˜¯renderä¾èµ–çš„å˜é‡å€¼ï¼Œç”¨useMemoï¼Œä¸ç”¨useEffect+useStateã€‚</p>

<p>ä¸æ¨èï¼š
<code>
function TodoList({ todos, filter }) {
  const [newTodo, setNewTodo] = useState('');
  // ğŸ”´ Avoid: redundant state and unnecessary Effect
  const [visibleTodos, setVisibleTodos] = useState([]);
  useEffect(() =&gt; {
    setVisibleTodos(getFilteredTodos(todos, filter));
  }, [todos, filter]);
  // ...
}
</code>
æ¨èï¼š
<code>
import { useMemo, useState } from 'react';
function TodoList({ todos, filter }) {
  const [newTodo, setNewTodo] = useState('');
  const visibleTodos = useMemo(() =&gt; {
    // âœ… Does not re-run unless todos or filter change
    return getFilteredTodos(todos, filter);
  }, [todos, filter]);
  // ...
}
</code></p>

<h2>two ways to store previous props</h2>

<h3>useRef</h3>

<p><code>prevProps</code> updates after render:
<code>
  const prevProps = useRef();
  useEffect(() =&gt; {
    prevProps.current = props;
  }, [props]);
</code></p>

<h3>useState</h3>

<p><code>prevItems</code> is ready when render:
<code>
  const [prevItems, setPrevItems] = useState(items);
  if (items !== prevItems) {
    setPrevItems(items);
  }
</code></p>

<h2>fetch dataçš„ä¸¤ä¸ªé—®é¢˜</h2>

<h3>race condition</h3>

<p>è¾“å…¥ç‰¹åˆ«å¿«çš„æ—¶å€™ï¼Œå¾ˆå¤šsearchçš„requestè¿ç»­å‘å‡ºï¼Œä¸èƒ½ä¿è¯å›æ¥çš„é¡ºåºï¼Œä¼šå‡ºé—®é¢˜ã€‚
è§£å†³æ–¹æ³•ï¼šç»™useEffectæä¾›cleanupå‡½æ•°è§£å†³
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function SearchResults({ query }) {
</span><span class='line'>  const [results, setResults] = useState([]);
</span><span class='line'>  const [page, setPage] = useState(1);
</span><span class='line'>  useEffect(() =&gt; {
</span><span class='line'>    let ignore = false;
</span><span class='line'>    fetchResults(query, page).then(json =&gt; {
</span><span class='line'>      if (!ignore) {
</span><span class='line'>        setResults(json);
</span><span class='line'>      }
</span><span class='line'>    });
</span><span class='line'>    return () =&gt; {
</span><span class='line'>      ignore = true;
</span><span class='line'>    };
</span><span class='line'>  }, [query, page]);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  function handleNextPageClick() {
</span><span class='line'>    setPage(page + 1);
</span><span class='line'>  }
</span><span class='line'>  // &hellip;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure></p>

<h3>undo</h3>

<p>æ²¡çœ‹æ‡‚ï¼š<a href="https://react.dev/learn/you-might-not-need-an-effect#fetching-data">https://react.dev/learn/you-might-not-need-an-effect#fetching-data</a></p>

<h2>Effect Event</h2>

<h3>what is reactive</h3>

<p>variables which can change due to a re-render
* Logic inside event handlers (or Effect Event) is not reactive.
* Logic inside Effects is reactive.</p>

<h3>Problem</h3>

<pre><code>function ChatRoom({ roomId, theme }) {
  useEffect(() =&gt; {
    const connection = createConnection(serverUrl, roomId);
    connection.on('connected', () =&gt; {
      showNotification('Connected!', theme);
    });
    connection.connect();
    return () =&gt; {
      connection.disconnect()
    };
  }, [roomId, theme]); // âœ… All dependencies declared
  // ...
</code></pre>

<p>When reconnected, a notification will be shown, and the notificaiton will consider the theme.
But when the theme changes, the notification will also be shown, which is not expected.</p>

<h3>Solution:</h3>

<p>Use Effect Event to separate this non-reactive logic from the reactive Effect around it.
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function ChatRoom({ roomId, theme }) {
</span><span class='line'>  const onConnected = useEffectEvent(() =&gt; {
</span><span class='line'>    showNotification(&lsquo;Connected!&rsquo;, theme);
</span><span class='line'>  });&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  useEffect(() =&gt; {
</span><span class='line'>    const connection = createConnection(serverUrl, roomId);
</span><span class='line'>    connection.on(&lsquo;connected&rsquo;, () =&gt; {
</span><span class='line'>      onConnected();
</span><span class='line'>    });
</span><span class='line'>    connection.connect();
</span><span class='line'>    return () =&gt; connection.disconnect();
</span><span class='line'>  }, [roomId]); // âœ… All dependencies declared
</span><span class='line'>  // &hellip;</span></code></pre></td></tr></table></div></figure></p>

<p>You can think of Effect Events as being very similar to event handlers. The main difference is that event handlers run in response to a user interactions, whereas Effect Events are triggered by you from Effects. Effect Events let you â€œbreak the chainâ€ between the reactivity of Effects and code that should not be reactive.</p>

<h3>Supress react lint error</h3>

<p>React linter ask you to add all reactive variables into the Effect dependencies.
Effect Events let you fix many patterns where you might be tempted to suppress the dependency linter.</p>

<h2>How to review effect dependencies</h2>

<p>Every time you adjust the Effectâ€™s dependencies to reflect the code, look at the dependency list. Does it make sense for the Effect to re-run when any of these dependencies change? Sometimes, the answer is â€œnoâ€:</p>

<ul>
<li>You might want to re-execute different parts of your Effect under different conditions.</li>
<li>You might want to only read the latest value of some dependency instead of â€œreactingâ€ to its changes.</li>
<li>A dependency may change too often unintentionally because itâ€™s an object or a function.</li>
</ul>


<h3>ways to review and fix this</h3>

<ul>
<li>Should this code move to an event handler?</li>
<li>Is your Effect doing several unrelated things?

<ul>
<li>If different parts of your Effect should re-run for different reasons, split it into several Effects.</li>
</ul>
</li>
<li>Are you reading some state to calculate the next state?

<ul>
<li>Use update function. Use <code>setMessages([...messages, receivedMessage])</code> instead of <code>setMessages(msgs =&gt; [...msgs, receivedMessage])</code></li>
</ul>
</li>
<li>In JavaScript, objects and functions are considered different if they were created at different times.</li>
<li>Try to avoid object and function dependencies. Move them outside the component or inside the Effect.

<ul>
<li>Move static objects and functions outside your component
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function createOptions() {
</span><span class='line'>return {
</span><span class='line'>serverUrl: &lsquo;&lt;a href="https://localhost:1234"&gt;https://localhost:1234&lt;/a&gt;&rsquo;,
</span><span class='line'>roomId: &lsquo;music&rsquo;
</span><span class='line'>};
</span><span class='line'>}&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;p&gt;function ChatRoom() {
</span><span class='line'>  const [message, setMessage] = useState(&lsquo;&rsquo;);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  useEffect(() =&gt; {
</span><span class='line'>    const options = createOptions();
</span><span class='line'>    const connection = createConnection();
</span><span class='line'>    connection.connect();
</span><span class='line'>    return () =&gt; connection.disconnect();
</span><span class='line'>  }, []); // âœ… All dependencies declared
</span><span class='line'>  // &hellip;
</span><span class='line'>&lt;code&gt;
</span><span class='line'>    * Move dynamic objects and functions inside your Effect
</span><span class='line'>&lt;/code&gt;
</span><span class='line'>const serverUrl = &lsquo;&lt;a href="https://localhost:1234"&gt;https://localhost:1234&lt;/a&gt;&rsquo;;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;function ChatRoom({ roomId }) {
</span><span class='line'>  const [message, setMessage] = useState(&lsquo;&rsquo;);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  useEffect(() =&gt; {
</span><span class='line'>    const options = {
</span><span class='line'>      serverUrl: serverUrl,
</span><span class='line'>      roomId: roomId
</span><span class='line'>    };
</span><span class='line'>    const connection = createConnection(options);
</span><span class='line'>    connection.connect();
</span><span class='line'>    return () =&gt; connection.disconnect();
</span><span class='line'>  }, [roomId]); // âœ… All dependencies declared
</span><span class='line'>  // &hellip;
</span><span class='line'>&lt;code&gt;
</span><span class='line'>* Read primitive values from objects
</span><span class='line'>&lt;/code&gt;
</span><span class='line'>function ChatRoom({ options }) {
</span><span class='line'>  const [message, setMessage] = useState(&lsquo;&rsquo;);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  const { roomId, serverUrl } = options;
</span><span class='line'>  useEffect(() =&gt; {
</span><span class='line'>    const connection = createConnection({
</span><span class='line'>      roomId: roomId,
</span><span class='line'>      serverUrl: serverUrl
</span><span class='line'>    });
</span><span class='line'>    connection.connect();
</span><span class='line'>    return () =&gt; connection.disconnect();
</span><span class='line'>  }, [roomId, serverUrl]); // âœ… All dependencies declared
</span><span class='line'>  // &hellip;</span></code></pre></td></tr></table></div></figure></p>

<h2>Object and function compare</h2>

<pre><code>import { useState, useEffect } from 'react';
import { createConnection } from './chat.js';

const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId }) {
  const [message, setMessage] = useState('');

  // Temporarily disable the linter to demonstrate the problem
  // eslint-disable-next-line react-hooks/exhaustive-deps
  const options = {
    serverUrl: serverUrl,
    roomId: roomId
  };

  useEffect(() =&gt; {
    const connection = createConnection(options);
    connection.connect();
    return () =&gt; connection.disconnect();
  }, [options]);

  return (
    &lt;&gt;
      &lt;h1&gt;Welcome to the {roomId} room!&lt;/h1&gt;
      &lt;input value={message} onChange={e =&gt; setMessage(e.target.value)} /&gt;
    &lt;/&gt;
  );
}

export default function App() {
  const [roomId, setRoomId] = useState('general');
  return (
    &lt;&gt;
      &lt;label&gt;
        Choose the chat room:{' '}
        &lt;select
          value={roomId}
          onChange={e =&gt; setRoomId(e.target.value)}
        &gt;
          &lt;option value="general"&gt;general&lt;/option&gt;
          &lt;option value="travel"&gt;travel&lt;/option&gt;
          &lt;option value="music"&gt;music&lt;/option&gt;
        &lt;/select&gt;
      &lt;/label&gt;
      &lt;hr /&gt;
      &lt;ChatRoom roomId={roomId} /&gt;
    &lt;/&gt;
  );
}
</code></pre>

<p>In the example above, the input only updates the message state variable. From the userâ€™s perspective, this should not affect the chat connection. However, every time you update the message, your component re-renders. When your component re-renders, the code inside of it runs again from scratch.</p>

<p>A new options object is created from scratch on every re-render of the ChatRoom component. React sees that the options object is a different object from the options object created during the last render. This is why it re-synchronizes your Effect (which depends on options), and the chat re-connects as you type.</p>

<p>This problem only affects objects and functions. In JavaScript, each newly created object and function is considered distinct from all the others. It doesnâ€™t matter that the contents inside of them may be the same!</p>

<p>Object and function dependencies can make your Effect re-synchronize more often than you need.</p>

<p>This is why, whenever possible, you should try to avoid objects and functions as your Effectâ€™s dependencies. Instead, try moving them outside the component, inside the Effect, or extracting primitive values out of them.</p>

<h2>useMemo and useCallback</h2>

<ul>
<li>useMemo caches the result of calling your function.</li>
<li>useCallback caches the function itself. React will not call your function.</li>
</ul>


<h2>forwardRef</h2>

<p>First, get familar with <code>useRef</code>:</p>

<h3>useRef</h3>

<p>ref.current is set during the <em>commit</em> process, not <em>render</em> process, so do not read or write ref.current during rendering. We can use ref.current in event handler or useEffect.</p>

<h3>basic concepts</h3>

<pre><code>const MyInput = forwardRef(function MyInput(props, ref) {
  return (
    &lt;label&gt;
      {props.label}
      &lt;input ref={ref} /&gt;
    &lt;/label&gt;
  );
});
</code></pre>

<p>The ref attribute passed by the parent component. The ref can be an object or a function. You should either
* pass the ref you receive to another component, or
* pass it to useImperativeHandle.</p>

<h3>expose dom node</h3>

<p>The parent <code>Form</code> component accesses the \<input\> DOM node exposed by <code>MyInput</code>.
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import { forwardRef } from &lsquo;react&rsquo;;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;const MyInput = forwardRef(function MyInput(props, ref) {
</span><span class='line'>  const { label, &hellip;otherProps } = props;
</span><span class='line'>  return (
</span><span class='line'>    &lt;label&gt;
</span><span class='line'>      {label}
</span><span class='line'>      &lt;input {...otherProps} ref={ref} /&gt;
</span><span class='line'>    &lt;/label&gt;
</span><span class='line'>  );
</span><span class='line'>});&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;function Form() {
</span><span class='line'>  const ref = useRef(null);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  function handleClick() {
</span><span class='line'>    ref.current.focus();
</span><span class='line'>  }&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  return (
</span><span class='line'>    &lt;form&gt;
</span><span class='line'>      &lt;MyInput label="Enter your name:" ref={ref} /&gt;
</span><span class='line'>      &lt;button type="button" onClick={handleClick}&gt;
</span><span class='line'>        Edit
</span><span class='line'>      &lt;/button&gt;
</span><span class='line'>    &lt;/form&gt;
</span><span class='line'>  );
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure></p>

<h3>expose an object</h3>

<p>Use <code>useImperativeHandle</code> to expose an object referenced by <code>ref</code>:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import { forwardRef, useRef, useImperativeHandle } from &lsquo;react&rsquo;;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;const MyInput = forwardRef(function MyInput(props, ref) {
</span><span class='line'>  const inputRef = useRef(null);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  useImperativeHandle(ref, () =&gt; {
</span><span class='line'>    return {
</span><span class='line'>      focus() {
</span><span class='line'>        inputRef.current.focus();
</span><span class='line'>      },
</span><span class='line'>      scrollIntoView() {
</span><span class='line'>        inputRef.current.scrollIntoView();
</span><span class='line'>      },
</span><span class='line'>    };
</span><span class='line'>  }, []);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  return &lt;input {...props} ref={inputRef} /&gt;;
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure></p>

<h2>Custom Hook</h2>

<p>You must follow these naming conventions:</p>

<ul>
<li>React component names must start with a capital letter, like StatusBar and SaveButton. React components also need to return something that React knows how to display, like a piece of JSX.</li>
<li>Hook names must start with use followed by a capital letter, like useState (built-in) or useOnlineStatus (custom, like earlier on the page). Hooks may return arbitrary values.</li>
</ul>


<p>This convention guarantees that you can always look at a component and know where its state, Effects, and other React features might â€œhideâ€. For example, if you see a getColor() function call inside your component, you can be sure that it canâ€™t possibly contain React state inside because its name doesnâ€™t start with use. However, a function call like useOnlineStatus() will most likely contain calls to other Hooks inside!</p>

<p>If your linter is configured for React, it will enforce this naming convention.</p>

<p>Note that custom Hooks only share stateful logic, not state itself.</p>

<h2>strict mode</h2>

<p><StrictMode> lets you find common bugs in your components early during development.</p>

<p>Strict Mode enables the following development-only behaviors:
* Your components will re-render an extra time to find bugs caused by impure rendering.
* Your components will re-run Effects an extra time to find bugs caused by missing Effect cleanup.
* Your components will be checked for usage of deprecated APIs.</p>

<h2>Other Rules</h2>

<h3>data from parent to child</h3>

<p>When child components update the state of their parent components in Effects, the data flow becomes very difficult to trace. Since both the child and the parent need the same data, let the parent component fetch that data, and pass it down to the child.
This is simpler and keeps the data flow predictable: the data flows down from the parent to the child.</p>

<h3>useSyncExternalStore</h3>

<h3>useEffect dependencies</h3>

<p>All variables from the component body used by the Effect should be in the Effect dependency list. However, you could instead â€œproveâ€ to the linter that these values arenâ€™t reactive values, i.e. that they canâ€™t change as a result of a re-render. For example, if serverUrl and roomId donâ€™t depend on rendering and always have the same values, you can move them outside the component. Now they donâ€™t need to be dependencies:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>const serverUrl = &lsquo;&lt;a href="https://localhost:1234"&gt;https://localhost:1234&lt;/a&gt;&rsquo;; // serverUrl is not reactive
</span><span class='line'>const roomId = &lsquo;general&rsquo;; // roomId is not reactive&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;function ChatRoom() {
</span><span class='line'>  useEffect(() =&gt; {
</span><span class='line'>    const connection = createConnection(serverUrl, roomId);
</span><span class='line'>    connection.connect();
</span><span class='line'>    return () =&gt; {
</span><span class='line'>      connection.disconnect();
</span><span class='line'>    };
</span><span class='line'>  }, []); // âœ… All dependencies declared
</span><span class='line'>  // &hellip;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure></p>
]]></content>
  </entry>
  
</feed>
