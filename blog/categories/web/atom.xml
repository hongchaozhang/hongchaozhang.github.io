<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: web | Reading Space]]></title>
  <link href="http://hongchaozhang.github.io/blog/categories/web/atom.xml" rel="self"/>
  <link href="http://hongchaozhang.github.io/"/>
  <updated>2025-04-11T00:23:23+08:00</updated>
  <id>http://hongchaozhang.github.io/</id>
  <author>
    <name><![CDATA[Zhang Hongchao]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Babelå·¥ä½œåŸç†]]></title>
    <link href="http://hongchaozhang.github.io/blog/2025/03/24/babel-workflow/"/>
    <updated>2025-03-24T23:20:31+08:00</updated>
    <id>http://hongchaozhang.github.io/blog/2025/03/24/babel-workflow</id>
    <content type="html"><![CDATA[<!-- more -->


<p>Babel is a JavaScript compilerã€‚
ä¸»è¦ç”¨äºå°† ECMAScript 2015+ï¼ˆES6 åŠä»¥ä¸Šï¼‰çš„ JavaScript ä»£ç è½¬æ¢æˆèƒ½å¤Ÿåœ¨å½“å‰å’Œæ—§ç‰ˆæµè§ˆå™¨ç¯å¢ƒä¸­å…¼å®¹è¿è¡Œçš„ä»£ç ç‰ˆæœ¬ã€‚</p>

<h1>é…ç½®</h1>

<p>Babel çš„é…ç½®æ–‡ä»¶é€šå¸¸æ˜¯<code>.babelrc.json</code>æˆ–<code>babel.config.json</code>ï¼Œå¯ä»¥åœ¨å…¶ä¸­é…ç½®éœ€è¦ä½¿ç”¨çš„æ’ä»¶å’Œé¢„è®¾:</p>

<pre><code>{
  "presets": [...],
  "plugins": [...]
}
</code></pre>

<p>ç”šè‡³å¯ä»¥ç›´æ¥å†™åœ¨<code>package.json</code>ä¸­ï¼š</p>

<pre><code>{
  ...,
  "babel": {
    "presets": [...],
    "plugins": [...]
  },
  ...
}
</code></pre>

<p>æ›´åŠ çµæ´»çš„ï¼Œå¯ä»¥åœ¨<code>webpack.config.js</code>ä¸­è®¿é—® Node.js çš„ APIsï¼š</p>

<pre><code>module.exports = function (api) {
  api.cache(true);

  const presets = [ ... ];
  const plugins = [ ... ];

  if (process.env["ENV"] === "prod") {
    plugins.push(...);
  }

  return {
    presets,
    plugins
  };
}
</code></pre>

<h1>å·¥ä½œæµç¨‹</h1>

<p><img src="/images/babel-workflow.png" alt="babel workflow" /></p>

<p>Babel çš„ç¼–è¯‘è¿‡ç¨‹ä¸å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘å™¨ç±»ä¼¼ï¼Œåˆ†ä¸ºä¸‰ä¸ªä¸»è¦é˜¶æ®µï¼šè§£æï¼ˆParsingï¼‰ã€è½¬æ¢ï¼ˆTransformationï¼‰å’Œç”Ÿæˆï¼ˆCode Generationï¼‰</p>

<h2>è§£æï¼ˆParsingï¼‰</h2>

<p>è¿™ä¸€é˜¶æ®µå°†ä»£ç å­—ç¬¦ä¸²è§£ææˆæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼ŒAbstract Syntax Treeï¼‰<a href="https://developer.aliyun.com/article/1303957">2</a><a href="https://blog.csdn.net/ByteDanceTech/article/details/126900235">3</a>ã€‚AST æ˜¯æºä»£ç çš„æŠ½è±¡è¯­æ³•ç»“æ„çš„æ ‘çŠ¶è¡¨ç¤ºï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„<a href="https://developer.aliyun.com/article/1303957">2</a>ã€‚
è§£æè¿‡ç¨‹åˆåˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š</p>

<ul>
<li>åˆ†è¯ï¼šå°†æ•´ä¸ªä»£ç å­—ç¬¦ä¸²åˆ†å‰²æˆè¯­æ³•å•å…ƒæ•°ç»„ï¼štokenizerï¼Œkeyword</li>
<li>è¯­æ³•åˆ†æï¼šå»ºç«‹åˆ†æè¯­æ³•å•å…ƒä¹‹é—´çš„å…³ç³»<a href="https://developer.aliyun.com/article/1303957">2</a></li>
</ul>


<p>ä¾‹å¦‚ï¼Œä¸€ä¸ªç®€å•çš„<code>console.log('zcy');</code>ä¼šè¢«è§£ææˆåŒ…å«ç¨‹åºç»“æ„ã€è¡¨è¾¾å¼è¯­å¥ã€è°ƒç”¨è¡¨è¾¾å¼ç­‰èŠ‚ç‚¹çš„ AST<a href="https://developer.aliyun.com/article/1303957">2</a>ã€‚</p>

<pre><code>{
  "type": "Program",
  "body": [
    {
      "type": "ExpressionStatement",
      "expression": {
        "type": "CallExpression",
        "callee": {
          "type": "MemberExpression",
          "computed": false,
          "object": {
            "type": "Identifier",
            "name": "console"
          },
          "property": {
            "type": "Identifier",
            "name": "log"
          }
        },
        "arguments": [
          {
          "type": "Literal",
          "value": "zcy",
          "raw": "'zcy'"
          }
        ]
      }
    }
  ],
  "sourceType": "script"
}
</code></pre>

<h2>è½¬æ¢ï¼ˆTransformationï¼‰</h2>

<p>è¿™ä¸€é˜¶æ®µå¯¹ AST è¿›è¡Œè½¬æ¢æ“ä½œ<a href="https://developer.aliyun.com/article/1303957">2</a><a href="https://blog.csdn.net/ByteDanceTech/article/details/126900235">3</a>ã€‚è½¬æ¢é€šå¸¸é€šè¿‡ Babel pluginï¼ˆæ’ä»¶ï¼‰æˆ–è€… presetï¼ˆé¢„è®¾ï¼‰å®ç°ï¼Œæ¯ä¸ªæ’ä»¶å¯ä»¥è®¿é—® AST å¹¶å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œä¾‹å¦‚å°†ç®­å¤´å‡½æ•°çš„èŠ‚ç‚¹è½¬æ¢ä¸ºæ™®é€šå‡½æ•°èŠ‚ç‚¹ã€‚</p>

<h3>pluginï¼ˆæ’ä»¶ï¼‰</h3>

<p>Babel æœ¬èº«åªæ˜¯ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ¡†æ¶ï¼Œå°±åƒä¸€ä¸ªçº¯å‡½æ•°<code>const babel = code =&gt; code</code>ä¸€æ ·ï¼Œåªè´Ÿè´£è§£æç„¶åç”Ÿæˆä»£ç ã€‚è¦å®ç°å…·ä½“çš„è½¬æ¢åŠŸèƒ½ï¼Œéœ€è¦æ·»åŠ å’Œä½¿ç”¨æ’ä»¶ï¼ˆpluginsï¼‰ã€‚
ä¾‹å¦‚ï¼Œè¦å°†ç®­å¤´å‡½æ•°è½¬æ¢ä¸ºæ™®é€šå‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨å®˜æ–¹æä¾›çš„<code>@babel/plugin-transform-arrow-functions</code>æ’ä»¶<a href="https://www.xuwenchao.site/blogs/babel.html">1</a>ã€‚æ¯ä¸ªæ’ä»¶è´Ÿè´£ç‰¹å®šç±»å‹çš„è¯­æ³•è½¬æ¢ï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ ç›¸åº”çš„æ’ä»¶ã€‚</p>

<h3>presetsï¼ˆé¢„è®¾ï¼‰</h3>

<p>å¦‚æœè¦ç¼–è¯‘ä¸€ä¸ªå®Œæ•´çš„åº”ç”¨ï¼Œå•ç‹¬é…ç½®æ¯ä¸ªæ‰€éœ€çš„æ’ä»¶ä¼šéå¸¸ç¹çã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒBabel å¼•å…¥äº† presetsï¼ˆé¢„è®¾ï¼‰çš„æ¦‚å¿µ<a href="https://www.xuwenchao.site/blogs/babel.html">1</a>ã€‚
presets å¯ä»¥ç†è§£ä¸º plugins å’Œéƒ¨åˆ†é…ç½®çš„é›†åˆï¼Œä½¿ç”¨é¢„è®¾å¯ä»¥é¿å…å•ç‹¬é…ç½®æ¯ä¸ª plugin å’Œå‚æ•°ï¼Œç›´æ¥ä½¿ç”¨å·²ç»ç»„åˆå¥½çš„é…ç½®å³å¯<a href="https://www.xuwenchao.site/blogs/babel.html">1</a>ã€‚å¸¸è§çš„é¢„è®¾åŒ…æ‹¬<code>@babel/preset-env</code>ã€<code>@babel/preset-react</code>ç­‰ã€‚</p>

<p>@babel/preset-env åŒ…å«ä»¥ä¸‹æ’ä»¶ï¼š</p>

<ul>
<li>@babel/plugin-transform-template-literals</li>
<li>@babel/plugin-transform-literals</li>
<li>@babel/plugin-transform-function-name</li>
<li>@babel/plugin-transform-arrow-functions</li>
<li>@babel/plugin-transform-block-scoped-functions</li>
<li>@babel/plugin-transform-classes</li>
<li>@babel/plugin-transform-object-super</li>
</ul>


<p>@babel/preset-react åŒ…å«ä»¥ä¸‹æ’ä»¶ï¼š</p>

<ul>
<li>@babel/plugin-syntax-jsx</li>
<li>@babel/plugin-transform-react-jsx</li>
<li>@babel/plugin-transform-react-display-name</li>
</ul>


<h2>ç”Ÿæˆï¼ˆCode Generationï¼‰</h2>

<p>æœ€åä¸€ä¸ªé˜¶æ®µæ˜¯æ ¹æ®è½¬æ¢åçš„ AST ç”Ÿæˆæ–°çš„ä»£ç å­—ç¬¦ä¸²ã€‚è¿™ä¸€è¿‡ç¨‹åŒ…æ‹¬å°† AST ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æ˜ å°„å›å­—ç¬¦ä¸²å½¢å¼ï¼Œå¹¶ç”Ÿæˆæºç æ˜ å°„ï¼ˆsource mapsï¼‰ã€‚</p>

<h1>ç»“è®º</h1>

<p>Babel ä½œä¸ºç°ä»£å‰ç«¯å¼€å‘çš„é‡è¦å·¥å…·ï¼Œä¸ºå¼€å‘è€…æä¾›äº†ä½¿ç”¨æœ€æ–° JavaScript ç‰¹æ€§çš„èƒ½åŠ›ï¼ŒåŒæ—¶ä¿è¯äº†ä»£ç åœ¨å„ç§æµè§ˆå™¨ç¯å¢ƒä¸­çš„å…¼å®¹æ€§ã€‚æ·±å…¥ç†è§£ Babel çš„åŸºæœ¬æ¦‚å¿µã€å·¥ä½œæµç¨‹å’Œä½¿ç”¨æ–¹æ³•ï¼Œå¯¹äºå‰ç«¯å¼€å‘è€…æå‡å¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡æœ‰ç€é‡è¦æ„ä¹‰ã€‚</p>

<p>ä»å…¥é—¨çš„åŸºæœ¬ä½¿ç”¨ï¼Œåˆ°è¿›é˜¶çš„æ’ä»¶å¼€å‘ï¼Œå†åˆ°ä¸“ä¸šçš„æ€§èƒ½ä¼˜åŒ–ï¼ŒBabel çš„å­¦ä¹ æ˜¯ä¸€ä¸ªå¾ªåºæ¸è¿›çš„è¿‡ç¨‹ã€‚éšç€å¯¹ Babel çš„ä¸æ–­æ·±å…¥å­¦ä¹ å’Œå®è·µï¼Œå¼€å‘è€…èƒ½å¤Ÿæ›´åŠ çµæ´»åœ°åˆ©ç”¨è¿™ä¸€å·¥å…·ï¼Œæ„å»ºæ›´åŠ ç°ä»£åŒ–ã€é«˜æ•ˆçš„å‰ç«¯åº”ç”¨ã€‚</p>

<h1>åº”ç”¨åœºæ™¯</h1>

<ul>
<li>ç¼–è¾‘å™¨</li>
<li>LSP language server protocol</li>
<li>è¯­æ³•é«˜äº®ï¼Œè‡ªåŠ¨è¡¥å…¨</li>
<li>é™æ€ä»£ç åˆ†æ</li>
<li>ä»£ç è½¬æ¢</li>
<li>ä»£ç å‹ç¼©å’Œä¼˜åŒ–</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CSS resolution rules and specificity]]></title>
    <link href="http://hongchaozhang.github.io/blog/2024/06/17/css-resolution-rules-and-specificity/"/>
    <updated>2024-06-17T11:53:39+08:00</updated>
    <id>http://hongchaozhang.github.io/blog/2024/06/17/css-resolution-rules-and-specificity</id>
    <content type="html"><![CDATA[<!-- more -->


<h2>Description</h2>

<p>The css property doesn&rsquo;t take effect in the release build but works fine in the debug build.</p>

<h2>Root cause</h2>

<p>We applied two css classes in one dom node and didnâ€™t specify the priority (have the same css specificity (0,1,0)), thus the CSS class order matters: the latter one will override the previous one.</p>

<p>However, the css class order is not stable between the debug and release builds.</p>

<h2>Solution</h2>

<p>After fixing, the classes are like this:</p>

<p><img src="/images/css-specificity-1.png" alt="css-specificity-1" /></p>

<p>We can use the scss file helper tools in VS Code:</p>

<p><img src="/images/css-specificity-2.png" alt="css-specificity-2" /></p>

<p>Caution while nesting &amp; :</p>

<p><img src="/images/css-specificity-3.png" alt="css-specificity-3" /></p>

<h2><a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/Building_blocks/Cascade_and_inheritance">Cascade</a></h2>

<p>When two rules from the same cascade layer apply and both have equal specificity, the one that is defined last in the stylesheet is the one that will be used.</p>

<p>There are three factors to consider, listed here in increasing order of importance. Later ones overrule earlier ones:</p>

<h3>Source order</h3>

<h3><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Specificity">Specificity</a></h3>

<ul>
<li>one identifier selector has 1-0-0 specificity</li>
<li>one class selector (attribute selector) has 0-1-0 specificity</li>
<li>one element selector has 0-0-1 specificity</li>
<li>The specificity weight of :not/:is/:has comes from the selector parameter in the list of selectors with the highest specificity.</li>
<li>Combinators, such as +, >, ~, &ldquo; &rdquo;, and ||, may make a selector more specific in what is selected but they don&rsquo;t add any value to the specificity weight.</li>
</ul>


<p><img src="/images/css-specificity-4.png" alt="css-specificity-4" /></p>

<h3>Importance</h3>

<ul>
<li>inline style</li>
<li><code>!important</code>: DO NOT use <code>!important</code>. It makes the CSS hard to maintain and debug.

<ul>
<li>See a demo for <code>!important</code> <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/Building_blocks/Cascade_and_inheritance#!important">here</a>.</li>
</ul>
</li>
</ul>


<h2>Other info</h2>

<p>The VS Code should have issues with â€œspecificityâ€ calculation.</p>

<p><img src="/images/css-specificity-5.png" alt="css-specificity-5" /></p>

<p>The specificity should be 0-2-0.</p>

<p>More examples can be seen from here: <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Specificity#three-column_comparison">Specificity</a></p>

<p><img src="/images/css-specificity-6.png" alt="css-specificity-6" /></p>

<p>Some online css specificity calculator can be used for testing:</p>

<p><a href="https://specificity.keegan.st/">Specificity Calculator</a></p>

<h2>How to avoid such issues?</h2>

<ul>
<li>Make sure all the loaded CSSs have different css specificity.</li>
<li>Review the CSS in the developer tool.</li>
<li>For a specific css property, filter out all CSSs which contains it.</li>
<li>Make sure the CSS you want to apply have the highest css specificity.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[React Learning Note 2023]]></title>
    <link href="http://hongchaozhang.github.io/blog/2023/09/15/react-learning-note-2023/"/>
    <updated>2023-09-15T17:33:08+08:00</updated>
    <id>http://hongchaozhang.github.io/blog/2023/09/15/react-learning-note-2023</id>
    <content type="html"><![CDATA[<!-- more -->


<ul>
<li><a href="#react-state-is-updated-in-a-batch">React state is updated in a â€œbatchâ€</a></li>
<li><a href="#update-react-state-with-a-new-object-do-not-mute-existing-one">Update react state with a new object, do not mute existing one</a></li>
<li><a href="#declarative-ui">Declarative UI</a></li>
<li><a href="#react-redux">React-redux</a></li>
<li><a href="#hooks">Hooks</a></li>
<li><a href="#react%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F">Reactä¸­çš„å˜é‡</a></li>
<li><a href="#useeffect">useEffect</a>

<ul>
<li><a href="#clean-up-function">clean up function</a></li>
</ul>
</li>
<li><a href="#usememo">useMemo</a></li>
<li><a href="#two-ways-to-store-previous-props">two ways to store previous props</a>

<ul>
<li><a href="#useref">useRef</a></li>
<li><a href="#usestate">useState</a></li>
</ul>
</li>
<li><a href="#fetch-data%E7%9A%84%E4%B8%A4%E4%B8%AA%E9%97%AE%E9%A2%98">fetch dataçš„ä¸¤ä¸ªé—®é¢˜</a>

<ul>
<li><a href="#race-condition">race condition</a></li>
<li><a href="#undo">undo</a></li>
</ul>
</li>
<li><a href="#effect-event">Effect Event</a>

<ul>
<li><a href="#what-is-reactive">what is reactive</a></li>
<li><a href="#problem">Problem</a></li>
<li><a href="#solution">Solution:</a></li>
<li><a href="#supress-react-lint-error">Supress react lint error</a></li>
</ul>
</li>
<li><a href="#how-to-review-effect-dependencies">How to review effect dependencies</a>

<ul>
<li><a href="#ways-to-review-and-fix-this">ways to review and fix this</a></li>
</ul>
</li>
<li><a href="#object-and-function-compare">Object and function compare</a></li>
<li><a href="#usememo-and-usecallback">useMemo and useCallback</a></li>
<li><a href="#forwardref">forwardRef</a>

<ul>
<li><a href="#useref-1">useRef</a></li>
<li><a href="#basic-concepts">basic concepts</a></li>
<li><a href="#expose-dom-node">expose dom node</a></li>
<li><a href="#expose-an-object">expose an object</a></li>
</ul>
</li>
<li><a href="#custom-hook">Custom Hook</a></li>
<li><a href="#strict-mode">strict mode</a></li>
<li><a href="#other-rules">Other Rules</a>

<ul>
<li><a href="#data-from-parent-to-child">data from parent to child</a></li>
<li><a href="#usesyncexternalstore">useSyncExternalStore</a></li>
<li><a href="#useeffect-dependencies">useEffect dependencies</a></li>
</ul>
</li>
</ul>


<h2>React state is updated in a â€œbatchâ€</h2>

<p>This means that you can not get the state immediately after you change it.</p>

<p>number will be 1 after one click:
<code>
export default function Counter() {
  const [number, setNumber] = useState(0);
  return (
    &lt;&gt;
      &lt;h1&gt;{number}&lt;/h1&gt;
      &lt;button onClick={() =&gt; {
        setNumber(number + 1);
        setNumber(number + 1);
        setNumber(number + 1);
      }}&gt;+3&lt;/button&gt;
    &lt;/&gt;
  )
}
</code>
To make the number to be 3, pass a update function to the setNumber function. An update function will be queued and executed later.
<code>
export default function Counter() {
  const [number, setNumber] = useState(0);
  return (
    &lt;&gt;
      &lt;h1&gt;{number}&lt;/h1&gt;
      &lt;button onClick={() =&gt; {
        setNumber(n =&gt; n + 1);
        setNumber(n =&gt; n + 1);
        setNumber(n =&gt; n + 1);
      }}&gt;+3&lt;/button&gt;
    &lt;/&gt;
  )
}
</code></p>

<h2>Update react state with a new object, do not mute existing one</h2>

<p>Use <code>â€¦</code> , the object spread operator:
<code>
setPerson({
  ...person, // Copy the old fields
  firstName: e.target.value // But override this one
});
</code>
Note that spread syntax is shallow: it only copies one level deep. To update nested object:
<code>
setPerson({
  ...person, // Copy other fields
  artwork: { // but replace the artwork
    ...person.artwork, // with the same one
    city: 'New Delhi' // but in New Delhi!
  }
});
</code>
For updating array object:
<code>
setArtists([
  { id: nextId++, name: name },
  ...artists // Put old items at the end
]);
</code>
<code>Immer</code> is a popular library that lets you write using the convenient but mutating syntax and takes care of producing the copies for you.
<code>
updatePerson(draft =&gt; {
  draft.artwork.city = 'Lagos';
});
</code>
Using <code>Immer</code> for array:
<code>
updateMyTodos(draft =&gt; {
  const artwork = draft.find(a =&gt; a.id === artworkId);
  artwork.seen = nextSeen;
});
</code></p>

<h2>Declarative UI</h2>

<ul>
<li>Declarative programming means describing the UI for each visual state rather than micromanaging the UI (imperative).</li>
<li>When developing a component, Think in declarative UI way:

<ol>
<li>Identify all its visual states.</li>
<li>Determine the human and computer triggers for state changes.</li>
<li>Model the state with useState.</li>
<li>Remove non-essential state to avoid bugs and paradoxes.</li>
<li>Connect the event handlers to set state.</li>
</ol>
</li>
</ul>


<h2>React-redux</h2>

<ul>
<li>useReducer+useContext?</li>
<li>Provider</li>
<li>Context</li>
</ul>


<h2>Hooks</h2>

<ul>
<li>useContext: è·¨å±‚ä¼ è¾“propsï¼Œä¸ç”¨ä¸€å±‚ä¸€å±‚ä¼ ä¸‹å»</li>
<li>useEffect: Use them to synchronize your component with a system outside of React.</li>
</ul>


<h2>Reactä¸­çš„å˜é‡</h2>

<ul>
<li>Propsï¼šimmutable, è§¦å‘rerenderï¼Œä¸è®°å¿†(retained by component)</li>
<li>Stateï¼šimmutable, è§¦å‘rerenderï¼Œè®°å¿†(retained by React)</li>
<li>useRefï¼šmutable, ä¸è§¦å‘rerenderï¼Œè®°å¿†(retained by React)</li>
</ul>


<h2>useEffect</h2>

<p>Effects let you specify side effects that are caused by rendering itself, rather than by a particular event.</p>

<p>Effects run at the end of a <em>commit</em> after the screen updates. That is, useEffect â€œdelaysâ€ a piece of code from running until that render is reflected on the screen.</p>

<h3>clean up function</h3>

<p>You can use a clean up function to clean up the effect. For example, if you subscribe to an external data source, you can unsubscribe it in the clean up function.
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>useEffect(() =&gt; {
</span><span class='line'>  const connection = createConnection();
</span><span class='line'>  connection.connect();
</span><span class='line'>  return () =&gt; {
</span><span class='line'>    connection.disconnect();
</span><span class='line'>  };
</span><span class='line'>}, []);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;useEffect(() =&gt; {
</span><span class='line'>  function handleScroll(e) {
</span><span class='line'>    console.log(window.scrollX, window.scrollY);
</span><span class='line'>  }
</span><span class='line'>  window.addEventListener(&lsquo;scroll&rsquo;, handleScroll);
</span><span class='line'>  return () =&gt; window.removeEventListener(&lsquo;scroll&rsquo;, handleScroll);
</span><span class='line'>}, []);</span></code></pre></td></tr></table></div></figure>
<strong>React will call your cleanup function each time before the next Effect runs again, and one final time when the component unmounts (gets removed).</strong>
That is, the cleanup function runs not only during unmount, but before every re-render with changed dependencies.</p>

<h2>useMemo</h2>

<p>useMemoå’ŒuseEffectéƒ½å¯ä»¥åŠ ä¾èµ–ï¼Œä½†æ˜¯useMemoåœ¨renderè¿‡ç¨‹èµ·ä½œç”¨ï¼Œè€ŒuseEffectåœ¨commitä¹‹åèµ·ä½œç”¨ã€‚
æ‰€ä»¥ï¼Œå¦‚æœæ˜¯renderä¾èµ–çš„å˜é‡å€¼ï¼Œç”¨useMemoï¼Œä¸ç”¨useEffect+useStateã€‚</p>

<p>ä¸æ¨èï¼š
<code>
function TodoList({ todos, filter }) {
  const [newTodo, setNewTodo] = useState('');
  // ğŸ”´ Avoid: redundant state and unnecessary Effect
  const [visibleTodos, setVisibleTodos] = useState([]);
  useEffect(() =&gt; {
    setVisibleTodos(getFilteredTodos(todos, filter));
  }, [todos, filter]);
  // ...
}
</code>
æ¨èï¼š
<code>
import { useMemo, useState } from 'react';
function TodoList({ todos, filter }) {
  const [newTodo, setNewTodo] = useState('');
  const visibleTodos = useMemo(() =&gt; {
    // âœ… Does not re-run unless todos or filter change
    return getFilteredTodos(todos, filter);
  }, [todos, filter]);
  // ...
}
</code></p>

<h2>two ways to store previous props</h2>

<h3>useRef</h3>

<p><code>prevProps</code> updates after render:
<code>
  const prevProps = useRef();
  useEffect(() =&gt; {
    prevProps.current = props;
  }, [props]);
</code></p>

<h3>useState</h3>

<p><code>prevItems</code> is ready when render:
<code>
  const [prevItems, setPrevItems] = useState(items);
  if (items !== prevItems) {
    setPrevItems(items);
  }
</code></p>

<h2>fetch dataçš„ä¸¤ä¸ªé—®é¢˜</h2>

<h3>race condition</h3>

<p>è¾“å…¥ç‰¹åˆ«å¿«çš„æ—¶å€™ï¼Œå¾ˆå¤šsearchçš„requestè¿ç»­å‘å‡ºï¼Œä¸èƒ½ä¿è¯å›æ¥çš„é¡ºåºï¼Œä¼šå‡ºé—®é¢˜ã€‚
è§£å†³æ–¹æ³•ï¼šç»™useEffectæä¾›cleanupå‡½æ•°è§£å†³
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function SearchResults({ query }) {
</span><span class='line'>  const [results, setResults] = useState([]);
</span><span class='line'>  const [page, setPage] = useState(1);
</span><span class='line'>  useEffect(() =&gt; {
</span><span class='line'>    let ignore = false;
</span><span class='line'>    fetchResults(query, page).then(json =&gt; {
</span><span class='line'>      if (!ignore) {
</span><span class='line'>        setResults(json);
</span><span class='line'>      }
</span><span class='line'>    });
</span><span class='line'>    return () =&gt; {
</span><span class='line'>      ignore = true;
</span><span class='line'>    };
</span><span class='line'>  }, [query, page]);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  function handleNextPageClick() {
</span><span class='line'>    setPage(page + 1);
</span><span class='line'>  }
</span><span class='line'>  // &hellip;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure></p>

<h3>undo</h3>

<p>æ²¡çœ‹æ‡‚ï¼š<a href="https://react.dev/learn/you-might-not-need-an-effect#fetching-data">https://react.dev/learn/you-might-not-need-an-effect#fetching-data</a></p>

<h2>Effect Event</h2>

<h3>what is reactive</h3>

<p>variables which can change due to a re-render
* Logic inside event handlers (or Effect Event) is not reactive.
* Logic inside Effects is reactive.</p>

<h3>Problem</h3>

<pre><code>function ChatRoom({ roomId, theme }) {
  useEffect(() =&gt; {
    const connection = createConnection(serverUrl, roomId);
    connection.on('connected', () =&gt; {
      showNotification('Connected!', theme);
    });
    connection.connect();
    return () =&gt; {
      connection.disconnect()
    };
  }, [roomId, theme]); // âœ… All dependencies declared
  // ...
</code></pre>

<p>When reconnected, a notification will be shown, and the notificaiton will consider the theme.
But when the theme changes, the notification will also be shown, which is not expected.</p>

<h3>Solution:</h3>

<p>Use Effect Event to separate this non-reactive logic from the reactive Effect around it.
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function ChatRoom({ roomId, theme }) {
</span><span class='line'>  const onConnected = useEffectEvent(() =&gt; {
</span><span class='line'>    showNotification(&lsquo;Connected!&rsquo;, theme);
</span><span class='line'>  });&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  useEffect(() =&gt; {
</span><span class='line'>    const connection = createConnection(serverUrl, roomId);
</span><span class='line'>    connection.on(&lsquo;connected&rsquo;, () =&gt; {
</span><span class='line'>      onConnected();
</span><span class='line'>    });
</span><span class='line'>    connection.connect();
</span><span class='line'>    return () =&gt; connection.disconnect();
</span><span class='line'>  }, [roomId]); // âœ… All dependencies declared
</span><span class='line'>  // &hellip;</span></code></pre></td></tr></table></div></figure></p>

<p>You can think of Effect Events as being very similar to event handlers. The main difference is that event handlers run in response to a user interactions, whereas Effect Events are triggered by you from Effects. Effect Events let you â€œbreak the chainâ€ between the reactivity of Effects and code that should not be reactive.</p>

<h3>Supress react lint error</h3>

<p>React linter ask you to add all reactive variables into the Effect dependencies.
Effect Events let you fix many patterns where you might be tempted to suppress the dependency linter.</p>

<h2>How to review effect dependencies</h2>

<p>Every time you adjust the Effectâ€™s dependencies to reflect the code, look at the dependency list. Does it make sense for the Effect to re-run when any of these dependencies change? Sometimes, the answer is â€œnoâ€:</p>

<ul>
<li>You might want to re-execute different parts of your Effect under different conditions.</li>
<li>You might want to only read the latest value of some dependency instead of â€œreactingâ€ to its changes.</li>
<li>A dependency may change too often unintentionally because itâ€™s an object or a function.</li>
</ul>


<h3>ways to review and fix this</h3>

<ul>
<li>Should this code move to an event handler?</li>
<li>Is your Effect doing several unrelated things?

<ul>
<li>If different parts of your Effect should re-run for different reasons, split it into several Effects.</li>
</ul>
</li>
<li>Are you reading some state to calculate the next state?

<ul>
<li>Use update function. Use <code>setMessages([...messages, receivedMessage])</code> instead of <code>setMessages(msgs =&gt; [...msgs, receivedMessage])</code></li>
</ul>
</li>
<li>In JavaScript, objects and functions are considered different if they were created at different times.</li>
<li>Try to avoid object and function dependencies. Move them outside the component or inside the Effect.

<ul>
<li>Move static objects and functions outside your component
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function createOptions() {
</span><span class='line'>return {
</span><span class='line'>serverUrl: &lsquo;&lt;a href="https://localhost:1234"&gt;https://localhost:1234&lt;/a&gt;&rsquo;,
</span><span class='line'>roomId: &lsquo;music&rsquo;
</span><span class='line'>};
</span><span class='line'>}&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;p&gt;function ChatRoom() {
</span><span class='line'>  const [message, setMessage] = useState(&lsquo;&rsquo;);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  useEffect(() =&gt; {
</span><span class='line'>    const options = createOptions();
</span><span class='line'>    const connection = createConnection();
</span><span class='line'>    connection.connect();
</span><span class='line'>    return () =&gt; connection.disconnect();
</span><span class='line'>  }, []); // âœ… All dependencies declared
</span><span class='line'>  // &hellip;
</span><span class='line'>&lt;code&gt;
</span><span class='line'>    * Move dynamic objects and functions inside your Effect
</span><span class='line'>&lt;/code&gt;
</span><span class='line'>const serverUrl = &lsquo;&lt;a href="https://localhost:1234"&gt;https://localhost:1234&lt;/a&gt;&rsquo;;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;function ChatRoom({ roomId }) {
</span><span class='line'>  const [message, setMessage] = useState(&lsquo;&rsquo;);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  useEffect(() =&gt; {
</span><span class='line'>    const options = {
</span><span class='line'>      serverUrl: serverUrl,
</span><span class='line'>      roomId: roomId
</span><span class='line'>    };
</span><span class='line'>    const connection = createConnection(options);
</span><span class='line'>    connection.connect();
</span><span class='line'>    return () =&gt; connection.disconnect();
</span><span class='line'>  }, [roomId]); // âœ… All dependencies declared
</span><span class='line'>  // &hellip;
</span><span class='line'>&lt;code&gt;
</span><span class='line'>* Read primitive values from objects
</span><span class='line'>&lt;/code&gt;
</span><span class='line'>function ChatRoom({ options }) {
</span><span class='line'>  const [message, setMessage] = useState(&lsquo;&rsquo;);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  const { roomId, serverUrl } = options;
</span><span class='line'>  useEffect(() =&gt; {
</span><span class='line'>    const connection = createConnection({
</span><span class='line'>      roomId: roomId,
</span><span class='line'>      serverUrl: serverUrl
</span><span class='line'>    });
</span><span class='line'>    connection.connect();
</span><span class='line'>    return () =&gt; connection.disconnect();
</span><span class='line'>  }, [roomId, serverUrl]); // âœ… All dependencies declared
</span><span class='line'>  // &hellip;</span></code></pre></td></tr></table></div></figure></p>

<h2>Object and function compare</h2>

<pre><code>import { useState, useEffect } from 'react';
import { createConnection } from './chat.js';

const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId }) {
  const [message, setMessage] = useState('');

  // Temporarily disable the linter to demonstrate the problem
  // eslint-disable-next-line react-hooks/exhaustive-deps
  const options = {
    serverUrl: serverUrl,
    roomId: roomId
  };

  useEffect(() =&gt; {
    const connection = createConnection(options);
    connection.connect();
    return () =&gt; connection.disconnect();
  }, [options]);

  return (
    &lt;&gt;
      &lt;h1&gt;Welcome to the {roomId} room!&lt;/h1&gt;
      &lt;input value={message} onChange={e =&gt; setMessage(e.target.value)} /&gt;
    &lt;/&gt;
  );
}

export default function App() {
  const [roomId, setRoomId] = useState('general');
  return (
    &lt;&gt;
      &lt;label&gt;
        Choose the chat room:{' '}
        &lt;select
          value={roomId}
          onChange={e =&gt; setRoomId(e.target.value)}
        &gt;
          &lt;option value="general"&gt;general&lt;/option&gt;
          &lt;option value="travel"&gt;travel&lt;/option&gt;
          &lt;option value="music"&gt;music&lt;/option&gt;
        &lt;/select&gt;
      &lt;/label&gt;
      &lt;hr /&gt;
      &lt;ChatRoom roomId={roomId} /&gt;
    &lt;/&gt;
  );
}
</code></pre>

<p>In the example above, the input only updates the message state variable. From the userâ€™s perspective, this should not affect the chat connection. However, every time you update the message, your component re-renders. When your component re-renders, the code inside of it runs again from scratch.</p>

<p>A new options object is created from scratch on every re-render of the ChatRoom component. React sees that the options object is a different object from the options object created during the last render. This is why it re-synchronizes your Effect (which depends on options), and the chat re-connects as you type.</p>

<p>This problem only affects objects and functions. In JavaScript, each newly created object and function is considered distinct from all the others. It doesnâ€™t matter that the contents inside of them may be the same!</p>

<p>Object and function dependencies can make your Effect re-synchronize more often than you need.</p>

<p>This is why, whenever possible, you should try to avoid objects and functions as your Effectâ€™s dependencies. Instead, try moving them outside the component, inside the Effect, or extracting primitive values out of them.</p>

<h2>useMemo and useCallback</h2>

<ul>
<li>useMemo caches the result of calling your function.</li>
<li>useCallback caches the function itself. React will not call your function.</li>
</ul>


<h2>forwardRef</h2>

<p>First, get familar with <code>useRef</code>:</p>

<h3>useRef</h3>

<p>ref.current is set during the <em>commit</em> process, not <em>render</em> process, so do not read or write ref.current during rendering. We can use ref.current in event handler or useEffect.</p>

<h3>basic concepts</h3>

<pre><code>const MyInput = forwardRef(function MyInput(props, ref) {
  return (
    &lt;label&gt;
      {props.label}
      &lt;input ref={ref} /&gt;
    &lt;/label&gt;
  );
});
</code></pre>

<p>The ref attribute passed by the parent component. The ref can be an object or a function. You should either
* pass the ref you receive to another component, or
* pass it to useImperativeHandle.</p>

<h3>expose dom node</h3>

<p>The parent <code>Form</code> component accesses the \<input\> DOM node exposed by <code>MyInput</code>.
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import { forwardRef } from &lsquo;react&rsquo;;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;const MyInput = forwardRef(function MyInput(props, ref) {
</span><span class='line'>  const { label, &hellip;otherProps } = props;
</span><span class='line'>  return (
</span><span class='line'>    &lt;label&gt;
</span><span class='line'>      {label}
</span><span class='line'>      &lt;input {...otherProps} ref={ref} /&gt;
</span><span class='line'>    &lt;/label&gt;
</span><span class='line'>  );
</span><span class='line'>});&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;function Form() {
</span><span class='line'>  const ref = useRef(null);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  function handleClick() {
</span><span class='line'>    ref.current.focus();
</span><span class='line'>  }&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  return (
</span><span class='line'>    &lt;form&gt;
</span><span class='line'>      &lt;MyInput label="Enter your name:" ref={ref} /&gt;
</span><span class='line'>      &lt;button type="button" onClick={handleClick}&gt;
</span><span class='line'>        Edit
</span><span class='line'>      &lt;/button&gt;
</span><span class='line'>    &lt;/form&gt;
</span><span class='line'>  );
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure></p>

<h3>expose an object</h3>

<p>Use <code>useImperativeHandle</code> to expose an object referenced by <code>ref</code>:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import { forwardRef, useRef, useImperativeHandle } from &lsquo;react&rsquo;;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;const MyInput = forwardRef(function MyInput(props, ref) {
</span><span class='line'>  const inputRef = useRef(null);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  useImperativeHandle(ref, () =&gt; {
</span><span class='line'>    return {
</span><span class='line'>      focus() {
</span><span class='line'>        inputRef.current.focus();
</span><span class='line'>      },
</span><span class='line'>      scrollIntoView() {
</span><span class='line'>        inputRef.current.scrollIntoView();
</span><span class='line'>      },
</span><span class='line'>    };
</span><span class='line'>  }, []);&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  return &lt;input {...props} ref={inputRef} /&gt;;
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure></p>

<h2>Custom Hook</h2>

<p>You must follow these naming conventions:</p>

<ul>
<li>React component names must start with a capital letter, like StatusBar and SaveButton. React components also need to return something that React knows how to display, like a piece of JSX.</li>
<li>Hook names must start with use followed by a capital letter, like useState (built-in) or useOnlineStatus (custom, like earlier on the page). Hooks may return arbitrary values.</li>
</ul>


<p>This convention guarantees that you can always look at a component and know where its state, Effects, and other React features might â€œhideâ€. For example, if you see a getColor() function call inside your component, you can be sure that it canâ€™t possibly contain React state inside because its name doesnâ€™t start with use. However, a function call like useOnlineStatus() will most likely contain calls to other Hooks inside!</p>

<p>If your linter is configured for React, it will enforce this naming convention.</p>

<p>Note that custom Hooks only share stateful logic, not state itself.</p>

<h2>strict mode</h2>

<p><StrictMode> lets you find common bugs in your components early during development.</p>

<p>Strict Mode enables the following development-only behaviors:
* Your components will re-render an extra time to find bugs caused by impure rendering.
* Your components will re-run Effects an extra time to find bugs caused by missing Effect cleanup.
* Your components will be checked for usage of deprecated APIs.</p>

<h2>Other Rules</h2>

<h3>data from parent to child</h3>

<p>When child components update the state of their parent components in Effects, the data flow becomes very difficult to trace. Since both the child and the parent need the same data, let the parent component fetch that data, and pass it down to the child.
This is simpler and keeps the data flow predictable: the data flows down from the parent to the child.</p>

<h3>useSyncExternalStore</h3>

<h3>useEffect dependencies</h3>

<p>All variables from the component body used by the Effect should be in the Effect dependency list. However, you could instead â€œproveâ€ to the linter that these values arenâ€™t reactive values, i.e. that they canâ€™t change as a result of a re-render. For example, if serverUrl and roomId donâ€™t depend on rendering and always have the same values, you can move them outside the component. Now they donâ€™t need to be dependencies:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>const serverUrl = &lsquo;&lt;a href="https://localhost:1234"&gt;https://localhost:1234&lt;/a&gt;&rsquo;; // serverUrl is not reactive
</span><span class='line'>const roomId = &lsquo;general&rsquo;; // roomId is not reactive&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;function ChatRoom() {
</span><span class='line'>  useEffect(() =&gt; {
</span><span class='line'>    const connection = createConnection(serverUrl, roomId);
</span><span class='line'>    connection.connect();
</span><span class='line'>    return () =&gt; {
</span><span class='line'>      connection.disconnect();
</span><span class='line'>    };
</span><span class='line'>  }, []); // âœ… All dependencies declared
</span><span class='line'>  // &hellip;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[é‡å­¦å‰ç«¯-é€šè¿‡windowå±æ€§äº†è§£åè®®API]]></title>
    <link href="http://hongchaozhang.github.io/blog/2022/10/08/chongxueqianduan-tongguo-window-liaojie-protocol-api/"/>
    <updated>2022-10-08T17:18:04+08:00</updated>
    <id>http://hongchaozhang.github.io/blog/2022/10/08/chongxueqianduan-tongguo-window-liaojie-protocol-api</id>
    <content type="html"><![CDATA[<!-- more -->


<p>æµè§ˆå™¨çš„APIæ•°ç›®ç¹å¤šï¼Œè¿™ä¸€èŠ‚è¯¾ï¼Œæˆ‘è®¾è®¡äº†ä¸€ä¸ªå®éªŒï¼Œæˆ‘ä»¬ä¸€èµ·æ¥ç»™APIåˆ†åˆ†ç±»ã€‚</p>

<p>æˆ‘ä»¬æŒ‰ç…§æ¯ä¸ªAPIæ‰€åœ¨çš„æ ‡å‡†æ¥åˆ†ç±»ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ç”¨ä»£ç æ¥åå°„æµè§ˆå™¨ç¯å¢ƒä¸­å…¨å±€å¯¹è±¡çš„å±æ€§ï¼Œç„¶åæˆ‘ä»¬ç”¨JavaScriptçš„filteræ–¹æ³•æ¥é€æ­¥è¿‡æ»¤æ‰å·²çŸ¥çš„å±æ€§ã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ•´ç†APIçš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<ol>
<li>ä»Windowçš„å±æ€§ä¸­ï¼Œæ‰¾åˆ°APIåç§°ï¼›</li>
<li>æŸ¥é˜…MDNæˆ–è€…Googleï¼Œæ‰¾åˆ°APIæ‰€åœ¨çš„æ ‡å‡†ï¼›</li>
<li>é˜…è¯»æ ‡å‡†ï¼Œæ‰‹å·¥æˆ–è€…ç”¨ä»£ç æ•´ç†å‡ºæ ‡å‡†ä¸­åŒ…å«çš„APIï¼›</li>
<li>ç”¨ä»£ç åœ¨Windowçš„å±æ€§ä¸­è¿‡æ»¤æ‰æ ‡å‡†ä¸­æ¶‰åŠçš„APIã€‚</li>
<li>é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°æ‰€æœ‰çš„APIå¯¹åº”çš„æ ‡å‡†ã€‚</li>
</ol>


<p>åŸæ–‡ç‚¹å‡»<a href="/assets/resources/37%E4%B8%A8%E6%B5%8F%E8%A7%88%E5%99%A8API%EF%BC%88%E5%B0%8F%E5%AE%9E%E9%AA%8C%EF%BC%89%EF%BC%9A%E5%8A%A8%E6%89%8B%E6%95%B4%E7%90%86%E5%85%A8%E9%83%A8API.html">è¿™é‡Œ</a>è·å–ã€‚</p>

<p>ä»åŸæ–‡æ•´ç†å‡ºæ¥çš„htmlæ–‡ä»¶ç‚¹å‡»<a href="/assets/resources/traverseWindows.html">è¿™é‡Œ</a>è·å–ã€‚</p>

<p>å…³é”®jsä»£ç å¦‚ä¸‹ï¼š</p>

<pre><code>function filterOut(names, props) {
    let set = new Set();
    props.forEach(o =&gt; set.add(o));
    return names.filter(e =&gt; !set.has(e));
}

let names = Object.getOwnPropertyNames(window)
console.log(names)

// è¿‡æ»¤JavaScript æ ‡å‡†è§„å®šçš„å±æ€§
let js = new Set();
let objects = ["BigInt", "BigInt64Array", "BigUint64Array", "Infinity", "NaN", "undefined", "eval", "isFinite", "isNaN", "parseFloat", "parseInt", "decodeURI", "decodeURIComponent", "encodeURI", "encodeURIComponent", "Array", "Date", "RegExp", "Promise", "Proxy", "Map", "WeakMap", "Set", "WeakSet", "Function", "Boolean", "String", "Number", "Symbol", "Object", "Error", "EvalError", "RangeError", "ReferenceError", "SyntaxError", "TypeError", "URIError", "ArrayBuffer", "SharedArrayBuffer", "DataView", "Float32Array", "Float64Array", "Int8Array", "Int16Array", "Int32Array", "Uint8Array", "Uint16Array", "Uint32Array", "Uint8ClampedArray", "Atomics", "JSON", "Math", "Reflect", "escape", "unescape"];
objects.forEach(o =&gt; js.add(o));
names = names.filter(e =&gt; !js.has(e));
console.log('\nnames after filtering JS Standard:')
console.log(names)

// æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å·²ç»è®²è¿‡çš„ DOM éƒ¨åˆ†ï¼ŒDOM éƒ¨åˆ†åŒ…å«äº† document å±æ€§å’Œä¸€ç³»åˆ—çš„æ„é€ å™¨ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ JavaScript çš„ prototype æ¥è¿‡æ»¤æ„é€ å™¨ã€‚
names = names.filter( e =&gt; {
    try { 
        return !(window[e].prototype instanceof Node)
    } catch(err) {
        return true;
    }
}).filter( e =&gt; e != "Node")
console.log('\nnames after filtering DOM:')
console.log(names)

// æ¥ä¸‹æ¥æˆ‘ä»¬è¦æ‰¾åˆ° Window å¯¹è±¡çš„å®šä¹‰ï¼Œæˆ‘ä»¬åœ¨ä¸‹é¢é“¾æ¥ä¸­å¯ä»¥æ‰¾åˆ°ã€‚https://html.spec.whatwg.org/#window è¿™é‡Œæœ‰ä¸€ä¸ª Window æ¥å£ï¼Œæ˜¯ä½¿ç”¨ WebIDL å®šä¹‰çš„ï¼Œæˆ‘ä»¬æ‰‹å·¥æŠŠå…¶ä¸­çš„å‡½æ•°å’Œå±æ€§æ•´ç†å‡ºæ¥
let windowprops = new Set();
objects = ["window", "self", "document", "name", "location", "history", "customElements", "locationbar", "menubar", " personalbar", "scrollbars", "statusbar", "toolbar", "status", "close", "closed", "stop", "focus", " blur", "frames", "length", "top", "opener", "parent", "frameElement", "open", "navigator", "applicationCache", "alert", "confirm", "prompt", "print", "postMessage", "console"];
objects.forEach(o =&gt; windowprops.add(o));
names = names.filter(e =&gt; !windowprops.has(e));
console.log('\nnames after filtering WebIDL:')
console.log(names)

// æˆ‘ä»¬è¿˜è¦è¿‡æ»¤æ‰æ‰€æœ‰çš„äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯ on å¼€å¤´çš„å±æ€§ã€‚
names = names.filter( e =&gt; !e.match(/^on/))
// webkit å‰ç¼€çš„ç§æœ‰å±æ€§æˆ‘ä»¬ä¹Ÿè¿‡æ»¤æ‰ï¼š
names = names.filter( e =&gt; !e.match(/^webkit/))
// é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬åœ¨ HTML æ ‡å‡†ä¸­è¿˜èƒ½æ‰¾åˆ°æ‰€æœ‰çš„æ¥å£ï¼Œè¿™äº›æˆ‘ä»¬ä¹Ÿè¿‡æ»¤æ‰ï¼š
let interfaces = new Set();
objects = ["ApplicationCache", "AudioTrack", "AudioTrackList", "BarProp", "BeforeUnloadEvent", "BroadcastChannel", "CanvasGradient", "CanvasPattern", "CanvasRenderingContext2D", "CloseEvent", "CustomElementRegistry", "DOMStringList", "DOMStringMap", "DataTransfer", "DataTransferItem", "DataTransferItemList", "DedicatedWorkerGlobalScope", "Document", "DragEvent", "ErrorEvent", "EventSource", "External", "FormDataEvent", "HTMLAllCollection", "HashChangeEvent", "History", "ImageBitmap", "ImageBitmapRenderingContext", "ImageData", "Location", "MediaError", "MessageChannel", "MessageEvent", "MessagePort", "MimeType", "MimeTypeArray", "Navigator", "OffscreenCanvas", "OffscreenCanvasRenderingContext2D", "PageTransitionEvent", "Path2D", "Plugin", "PluginArray", "PopStateEvent", "PromiseRejectionEvent", "RadioNodeList", "SharedWorker", "SharedWorkerGlobalScope", "Storage", "StorageEvent", "TextMetrics", "TextTrack", "TextTrackCue", "TextTrackCueList", "TextTrackList", "TimeRanges", "TrackEvent", "ValidityState", "VideoTrack", "VideoTrackList", "WebSocket", "Window", "Worker", "WorkerGlobalScope", "WorkerLocation", "WorkerNavigator"];
objects.forEach(o =&gt; interfaces.add(o));
names = names.filter(e =&gt; !interfaces.has(e));
console.log('\nnames after filtering HTML:')
console.log(names)

// è¿‡æ»¤i18n api
names = names.filter(e =&gt; e != "Intl")
console.log(names)

/* Streams æ ‡å‡†
    æ¥ä¸‹æ¥æˆ‘çœ‹åˆ°çš„å±æ€§æ˜¯ï¼š ByteLengthQueuingStrategyã€‚
    åŒæ ·ç»è¿‡æŸ¥é˜…ï¼Œå®ƒæ¥è‡ª WHATWG çš„ Streams æ ‡å‡†ï¼š
    https://streams.spec.whatwg.org/#blqs-class
*/
names = filterOut(names, ["ReadableStream", "ReadableStreamDefaultReader", "ReadableStreamBYOBReader", "ReadableStreamDefaultController", "ReadableByteStreamController", "ReadableStreamBYOBRequest", "WritableStream", "WritableStreamDefaultWriter", "WritableStreamDefaultController", "TransformStream", "TransformStreamDefaultController", "ByteLengthQueuingStrategy", "CountQueuingStrategy"]);
console.log(names)

/*
    æ¥ä¸‹æ¥æˆ‘çœ‹åˆ°çš„å±æ€§æ˜¯ï¼šWebGLContextâ€‹Eventã€‚
    æ˜¾ç„¶ï¼Œè¿™ä¸ªå±æ€§æ¥è‡ª WebGL æ ‡å‡†ï¼š
    https://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15
*/
names = filterOut(names, ["WebGLContextEvent","WebGLObject", "WebGLBuffer", "WebGLFramebuffer", "WebGLProgram", "WebGLRenderbuffer", "WebGLShader", "WebGLTexture", "WebGLUniformLocation", "WebGLActiveInfo", "WebGLShaderPrecisionFormat", "WebGLRenderingContext"]);
console.log(names)

/*
    Web Audio API
    ä¸‹ä¸€ä¸ªå±æ€§æ˜¯ WaveShaperNodeã€‚è¿™ä¸ªå±æ€§åå¬èµ·æ¥å°±è·Ÿå£°éŸ³æœ‰å…³ï¼Œè¿™ä¸ªå±æ€§æ¥è‡ª W3C çš„ Web Audio API æ ‡å‡†ã€‚
    æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ ‡å‡†ï¼š
    https://www.w3.org/TR/webaudio/
*/
names = filterOut(names, ["AudioContext", "AudioNode", "AnalyserNode", "AudioBuffer", "AudioBufferSourceNode", "AudioDestinationNode", "AudioParam", "AudioListener", "AudioWorklet", "AudioWorkletGlobalScope", "AudioWorkletNode", "AudioWorkletProcessor", "BiquadFilterNode", "ChannelMergerNode", "ChannelSplitterNode", "ConstantSourceNode", "ConvolverNode", "DelayNode", "DynamicsCompressorNode", "GainNode", "IIRFilterNode", "MediaElementAudioSourceNode", "MediaStreamAudioSourceNode", "MediaStreamTrackAudioSourceNode", "MediaStreamAudioDestinationNode", "PannerNode", "PeriodicWave", "OscillatorNode", "StereoPannerNode", "WaveShaperNode", "ScriptProcessorNode", "AudioProcessingEvent"]);
console.log(names)

/*
    Encoding æ ‡å‡†
    åœ¨æˆ‘çš„ç¯å¢ƒä¸­ï¼Œä¸‹ä¸€ä¸ªå±æ€§æ˜¯ TextDecoderï¼Œç»è¿‡æŸ¥é˜…å¾—çŸ¥ï¼Œè¿™ä¸ªå±æ€§ä¹Ÿæ¥è‡ªä¸€ä»½ WHATWG çš„æ ‡å‡†ï¼ŒEncodingï¼š
    https://encoding.spec.whatwg.org/#dom-textencoder
*/
names = filterOut(names, ["TextDecoder", "TextEncoder", "TextDecoderStream", "TextEncoderStream"]);
console.log(names)

/*
    Web Cryptography API
    æˆ‘ä»¬ç»§ç»­çœ‹ä¸‹å»ï¼Œä¸‹ä¸€ä¸ªå±æ€§æ˜¯ SubtleCryptoï¼Œè¿™ä¸ªå±æ€§æ¥è‡ª Web Cryptography APIï¼Œä¹Ÿæ˜¯ W3C çš„æ ‡å‡†ã€‚
    https://www.w3.org/TR/WebCryptoAPI/
    è¿™ä»½æ ‡å‡†ä¸­è§„å®šäº†ä¸‰ä¸ª Class å’Œä¸€ä¸ª Window å¯¹è±¡çš„æ‰©å±•ï¼Œç»™ Window å¯¹è±¡æ·»åŠ äº†ä¸€ä¸ªå±æ€§ cryptoã€‚
*/
names = filterOut(names, ["CryptoKey", "SubtleCrypto", "Crypto", "crypto"]);
console.log(names)

/*
    Media Source Extensions
    ä¸‹ä¸€ä¸ªå±æ€§æ˜¯ SourceBufferListï¼Œå®ƒæ¥è‡ªäºï¼š
    https://www.w3.org/TR/media-source/
    è¿™ä»½æ ‡å‡†ä¸­åŒ…å«äº†ä¸‰ä¸ªæ¥å£ï¼Œè¿™ä»½æ ‡å‡†è¿˜æ‰©å±•äº†ä¸€äº›æ¥å£ï¼Œä½†æ˜¯æ²¡æœ‰æ‰©å±• windowã€‚
*/
names = filterOut(names, ["MediaSource", "SourceBuffer", "SourceBufferList"]);
console.log(names)
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[webæ€§èƒ½ä¼˜åŒ–]]></title>
    <link href="http://hongchaozhang.github.io/blog/2022/03/21/web-xingneng-youhua/"/>
    <updated>2022-03-21T23:30:53+08:00</updated>
    <id>http://hongchaozhang.github.io/blog/2022/03/21/web-xingneng-youhua</id>
    <content type="html"><![CDATA[<!-- more -->


<p>ä»webæ¸²æŸ“å…¨è¿‡ç¨‹åˆ†æï¼Œä»ä¸‹é¢å‡ ä¸ªæ–¹é¢è¿›è¡Œæ€§èƒ½ä¼˜åŒ–è€ƒè™‘ï¼š</p>

<ol>
<li>HTTPè¯·æ±‚æ€§èƒ½ä¼˜åŒ–</li>
<li>æµè§ˆå™¨å†…æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–</li>
</ol>


<h2>HTTP(s)è¯·æ±‚æ€§èƒ½ä¼˜åŒ–</h2>

<ul>
<li>å‚è€ƒæå®¢æ—¶é—´è¯¾ç¨‹ã€Šé€è§†HTTPåè®®ã€‹çš„39å’Œ40ä¸¤èŠ‚è¯¾ã€‚</li>
<li>å¦å¤–ï¼Œ<a href="/blog/2021/05/26/toushi-http-xieyi/">æå®¢æ—¶é—´-ç½—å‰‘é”‹-ã€Šé€è§†HTTPåè®®ã€‹æ€»ç»“</a>ä¸­çš„ç« èŠ‚<a href="/blog/2021/05/26/toushi-http-xieyi/#http%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">httpæ€§èƒ½ä¼˜åŒ–</a>ï¼Œæœ‰ä¸€ä¸ªæ¦‚æ‹¬æ€§çš„æè¿°ã€‚</li>
<li>ç›¸å…³å†…å®¹ä¸ªäººæ€»ç»“å‚è€ƒ<a href="/blog/2022/03/08/http-xingneng-youhua/">HTTP(s)è¯·æ±‚æ€§èƒ½ä¼˜åŒ–</a>ã€‚</li>
</ul>


<h2>æµè§ˆå™¨å†…æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–</h2>

<ul>
<li>å‚è€ƒæå®¢æ—¶é—´è¯¾ç¨‹ã€Šè®©ä½ é¡µé¢é€Ÿåº¦é£èµ·æ¥ Webå‰ç«¯æ€§èƒ½ä¼˜åŒ–ã€‹</li>
<li>ç›¸å…³å†…å®¹ä¸ªäººæ€»ç»“å‚è€ƒ<a href="/blog/2022/01/04/web-qianduan-xingneng-youhua/">æå®¢æ—¶é—´-Webå‰ç«¯æ€§èƒ½ä¼˜åŒ–</a>ã€‚</li>
</ul>

]]></content>
  </entry>
  
</feed>
